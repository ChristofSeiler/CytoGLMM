---
title: "CytoGLMM Workflow"
author:
  name: Christof Seiler
  affiliation: Department of Statistics, Stanford University & Department of Data Science and Knowledge Engineering, Maastricht University
date: February 18, 2021
vignette: >
  %\VignetteIndexEntry{CytoGLMM Workflow}
  %\VignetteEngine{knitr::rmarkdown}
output:
  BiocStyle::html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.retina = 2, dpi = 96, fig.width = 7.2916667, fig.asp = 0.6178571)
```

# Goal

This is a step-by-step guide for a complete analysis of mass cytometry data.

# Prerequisites

Load packages.

```{r load_packages}
library("CytoGLMM")
library("tidyverse")
library("magrittr")
source("generate_data.R")
```

# Prepare Simulated Data

Generate data from a Poisson GLM with random effects.

```{r simulated_data}
set.seed(23)
df = generate_data()
df
```

Extract the marker names from the data frame.

```{r protein_names}
protein_names = names(df)[3:12]
```

Apply a data transformation.

```{r transform}
df %<>% dplyr::mutate_at(protein_names, function(x) asinh(x/5))
```

# GLMM

Fit model. It is normal to receive a warning about the covariance matrix estimate. This warning can be ignored.

```{r glmm_fit}
glmm_fit = CytoGLMM::cytoglmm(df,
                              protein_names = protein_names,
                              condition = "condition",
                              group = "donor",
                              num_cores = 1)
glmm_fit
```

Plot results.

```{r glmm_plot}
plot(glmm_fit)
```

Summarize results.

```{r glmm_summarize}
summary(glmm_fit)
```

Extract only proteins below an FDR of 0.05 from the $p$-value table.

```{r glmm_p_values}
summary(glmm_fit) %>% dplyr::filter(pvalues_adj < 0.05)
```

# GLM

Fit model.

```{r glm_fit}
glm_fit = CytoGLMM::cytoglm(df,
                            protein_names = protein_names,
                            condition = "condition",
                            group = "donor",
                            num_cores = 1,
                            num_boot = 1000)
glm_fit
```

Plot results.

```{r glm_plot}
plot(glm_fit)
```

Summarize results.

```{r glm_summarize}
summary(glm_fit)
```

Extract only proteins below an FDR of 0.05 from the $p$-value table.

```{r glm_p_values}
summary(glm_fit) %>% dplyr::filter(pvalues_adj < 0.05)
```

# Session Info {.unnumbered}

```{r session_info}
sessionInfo()
```
