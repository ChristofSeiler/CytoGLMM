---
title: "CytoGLMM Workflow"
author: "Christof Seiler"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

In this vignette we go through an entire CytoGLMM workflow with real data on NK cells and monocytes. The data is part of a bigger experiment studying the interaction between NK cells and monocytes after monocytes have been exposed to two influenza A strains. In this workflow, we focus on the comparison between the H1N1 and the H3N2 strain after 24 hours of infection. The goal is a differential analysis of protein (ligands) expression in monocyte cells.

## Load Packages

To read FCS files we use the `flowCore` package.

```{r load_packages}
library(CytoGLMM)
library(stringr)
library(flowCore)
```

## Read Data

To use the `CytoGLMM` package it is most convenient to convert the FCS files into a `data.frame` with marker expression as colums and cells as rows. Additionally, we append a column with donor identification numbers which will allows to account for donor specific variability.

```{r read_sample_table}
sample_table = read.csv("sample_table.csv")
sample_table$file_name = as.character(sample_table$file_name)
sample_table$donor = as.factor(sample_table$donor)
```

Read FCS files into a list and keep only markers that end with `Di`.

```{r read_fcs}
sample_list = lapply(sample_table$file_name,function(file_name_fcs) {
  fcsB = read.FCS(file_name_fcs,transformation = FALSE)
  marker_names = colnames(fcsB)[str_detect(colnames(fcsB),"[0-9]{1}Di")]
  marker_ids = which(colnames(fcsB) %in% marker_names)
  fcsB@exprs[,marker_ids]
})
length(sample_list)
```

Combine all samples into one `data.frame` and merge with information from sample table.

```{r combine_samples}
combine_samples = function(sample_id) {
  sample_info = sample_table[sample_id,]
  cat(as.character(sample_info$file_name),"\n")
  sample = sample_list[[sample_id]]
  rownames(sample_info) = NULL
  data.frame(sample,sample_info)
}
df_samples = lapply(1:length(sample_list),combine_samples) %>%
  do.call(rbind,.)
```

The combined `data.frame` whas the following dimensions and column names.

```{r}
dim(df_samples)
names(df_samples)
```

Change marker name from isotope name to protein name and remove markers that are unmapped.

```{r map_protein_names}
markers = read.csv("markers.csv",stringsAsFactors = FALSE)
markers$type = as.factor(markers$type)
for(i in 1:length(markers$isotope)) {
  isotope_name = markers$isotope[i]
  col_id = which(isotope_name==names(df_samples))
  names(df_samples)[col_id] = markers$protein_name[i]
}
unmapped = str_detect(names(df_samples),"[0-9]{1}Di")
df_samples = df_samples[,!unmapped]
num_markers = ncol(df_samples)-ncol(sample_table)
num_markers
protein_names = names(df_samples)[1:num_markers]
protein_names
```

Transform data with ``arcsinh`` and scale parameter set to $b = 1/5$ as in Bendall et al. 2011.

```{r transform_expressions}
b = 5
transform_expr = asinh(df_samples[1:num_markers]/b)
df_samples = data.frame(transform_expr,
                        df_samples[,(num_markers+1):ncol(df_samples)])
```

Now we are done with the data preparation steps. We have one `data.frame` we called `df_samples` that contains all the necessary information. We will now use the `CytoGLMM` package to visualize expression profiles and perform differential analysis.

```{r}
head(df_samples)
```

Plot overall cell counts across donors.

```{r cell_count,fig.height=3,fig.width=6}
table(df_samples$donor)
plot_cell_count(df_samples)
```

## Visualize Marker Expressions

The `CytoGLMM` provides some visualization functions to easily explore expression profiles. This is particullarly useful to explore the donor specific variabilty by decomposing the expression of each donor into facets.

```{r fig.height=5,fig.width=7}
plot_markers(df_samples = df_samples,
             donor_id = "160512",
             protein_names = protein_names)
plot_markers(df_samples = df_samples,
             donor_id = "160712",
             protein_names = protein_names)
```

Plot just one marker and facet by donor.

```{r fig.height=4,fig.width=5}
plot_donors(df_samples = df_samples,
            protein_name = "Nectin_2_CD112")
plot_donors(df_samples = df_samples,
            protein_name = "ICAM1_CD54")
```

## Regression

Under the hood: For the fast maximum likelihood solution, we load the `mbest` package. For sampling from the full Bayesian posterior distribution, we load the `rstan` package.

```{r maximum_likelihood}
res = glmm_ml(df_samples = df_samples,
                      protein_names = protein_names,
                      response = "condition")
```

Get a list of FDR adjusted p-values.

```{r pvalues}
pvalues(res)
```

Plot regression coefficient with confidence intervals.

```{r plot_ml,fig.height=4,fig.width=4}
plot(res)
```

Regression on marker that we know measures if a cell was actually infected. First, for the H1 strain.

```{r regression_H1,fig.height=4,fig.width=4}
res_H1 = glmm_ml(df_samples = subset(df_samples,condition == "H1"),
                 protein_names = protein_names[-which(protein_names == "NP")],
                 response = "NP")
plot(res_H1)
```

Then the same thing for the H3 strain.

```{r regression_H3,fig.height=4,fig.width=4}
res_H3 = glmm_ml(df_samples = subset(df_samples,condition == "H3"),
                 protein_names = protein_names[-which(protein_names == "NP")],
                 response = "NP")
plot(res_H3)
```

## Visualizing Results

Using PCA to visualize differentially expressed markers.

```{r pca_plot,fig.height=3,fig.width=7}
df_pvalues = pvalues(res)
df_pvalues_subset = subset(df_pvalues,pvalues_adj < 0.01)
plot_prcomp(df_samples,
            df_pvalues_subset$protein_names,
            color_var = "condition")
plot_prcomp(df_samples,
            df_pvalues_subset$protein_names,
            color_var = "donor")
```

## Pairwise Association Matrix

Latent class regression. We bin expressions into discrete categorical variables to handle multimodal marker expression profiles. The number of bins is a paramter to be set by the user. Choose a large enough bin size to capture the complexity of the marker distributions. However be aware that larger bin sizes will be harder to estimate (more variability in the estimates) and will take longer to compute. To speed up compuations we can subsample the data.

```{r}
fit_vb = lcr(df_samples_binned,
             protein_names,
             condition = "condition",
             num_latent_classes = 5,
             num_bins = 8,
             subsample = 10000)
```

Compute and plot one association matrix per stimulation condition.

```{r}
plot_pairwise_mi(fit_vb,
                 df_samples_binned,
                 protein_names)
```

Compute and plot the posterior probability that H1 is stronger dependent than H3 for each pair of markers. 

```{r}
plot_pairwise_mi_da(fit_vb,
                    df_samples_binned,
                    protein_names)
```

## Session Info

```{r}
sessionInfo()
```
