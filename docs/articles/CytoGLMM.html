<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CytoGLMM Workflow • CytoGLMM</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="CytoGLMM Workflow">
<meta property="og:description" content="CytoGLMM">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CytoGLMM</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/CytoGLMM.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ChristofSeiler/CytoGLMM/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>CytoGLMM Workflow</h1>
                        <h4 class="author">Christof Seiler</h4>
            <address class="author_afil">
      Department of Statistics, Stanford University<br><small class="dont-index">Source: <a href="https://github.com/ChristofSeiler/CytoGLMM/blob/master/vignettes/CytoGLMM.Rmd"><code>vignettes/CytoGLMM.Rmd</code></a></small>
      <div class="hidden name"><code>CytoGLMM.Rmd</code></div>

    </address>
</div>

    
    
<div id="goal" class="section level1">
<h1 class="hasAnchor">
<a href="#goal" class="anchor"></a>Goal</h1>
<p>This is a step-by-step guide for a complete analysis of mass cytometry data.</p>
</div>
<div id="prerequisites" class="section level1">
<h1 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h1>
<p>Install <a href="https://www.r-project.org/">R</a> and <a href="https://www.rstudio.com/">RStudio</a>. Open this <code>Rmd</code> file in RStudio. Then run the following code to install all required packages.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">pkgs_needed</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"devtools"</span>,<span class="st">"tidyverse"</span>,<span class="st">"magrittr"</span>,<span class="st">"FlowRepositoryR"</span>,
                <span class="st">"flowCore"</span>,<span class="st">"openCyto"</span>,<span class="st">"scales"</span>,<span class="st">"parallel"</span>,
                <span class="st">"RColorBrewer"</span>,<span class="st">"ggcorrplot"</span>,<span class="st">"SummarizedExperiment"</span>,
                <span class="st">"lme4"</span>,<span class="st">"lmerTest"</span>)
<span class="no">letsinstall</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">setdiff</a></span>(<span class="no">pkgs_needed</span>, <span class="fu"><a href="https://rdrr.io/r/utils/installed.packages.html">installed.packages</a></span>())
<span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">letsinstall</span>) <span class="kw">&gt;</span> <span class="fl">0</span>) {
  <span class="kw pkg">BiocManager</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html">install</a></span>(<span class="no">letsinstall</span>)
}
<span class="co"># package is still private</span>
<span class="kw pkg">devtools</span><span class="kw ns">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span>(<span class="st">"ChristofSeiler/CytoGLMM"</span>)
<span class="co"># Bioconductor version breaks when updating to ggplot2 v3.0</span>
<span class="kw pkg">devtools</span><span class="kw ns">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span>(<span class="st">"RGLab/ggcyto"</span>, <span class="kw">ref</span><span class="kw">=</span><span class="st">"trunk"</span>)</pre></body></html></div>
<p>Load packages.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"CytoGLMM"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"tidyverse"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"magrittr"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"FlowRepositoryR"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"flowCore"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"openCyto"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"ggcyto"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"scales"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"parallel"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"RColorBrewer"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"ggcorrplot"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"SummarizedExperiment"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"lme4"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="st">"lmerTest"</span>)</pre></body></html></div>
<p>Set plotting style and assign computational resources.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu">theme_set</span>(<span class="fu">theme_light</span>())
<span class="no">ncores</span> <span class="kw">=</span> <span class="kw pkg">parallel</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html">detectCores</a></span>()</pre></body></html></div>
</div>
<div id="download-and-prepare-data" class="section level1">
<h1 class="hasAnchor">
<a href="#download-and-prepare-data" class="anchor"></a>Download and Prepare Data</h1>
<div id="fcs-files" class="section level2">
<h2 class="hasAnchor">
<a href="#fcs-files" class="anchor"></a>FCS Files</h2>
<p>Reanalysis of mass cytometry data from <span class="citation">Aghaeepour et al. (2017)</span>. We use the package <code>FlowRepositoryR</code> to download <code>fcs</code> files from <a href="http://flowrepository.org/id/FR-FCM-ZY3Q">FlowRepository</a>. We download mass cytometry data measured on whole blood samples collected from 16 women during pregnancy stimulated with IFNa at first and third trimester.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">repo</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/FlowRepositoryR/man/flowRep.get.html">flowRep.get</a></span>(<span class="st">"FR-FCM-ZY3Q"</span>)
<span class="no">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/FlowRepositoryR/man/download-methods.html">download</a></span>(<span class="no">repo</span>, <span class="kw">only.files</span> <span class="kw">=</span> <span class="st">".*_2_IFNa.*fcs"</span>)
<span class="no">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/FlowRepositoryR/man/download-methods.html">download</a></span>(<span class="no">repo</span>, <span class="kw">only.files</span> <span class="kw">=</span> <span class="st">".*_1_IFNa.*fcs"</span>)
<span class="no">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/FlowRepositoryR/man/download-methods.html">download</a></span>(<span class="no">repo</span>, <span class="kw">only.files</span> <span class="kw">=</span> <span class="st">".*_BL_IFNa.*fcs"</span>)</pre></body></html></div>
</div>
<div id="sample-table" class="section level2">
<h2 class="hasAnchor">
<a href="#sample-table" class="anchor"></a>Sample Table</h2>
<p>The previous commands downloaded <code>fcs</code> files to the <code>FR-FCM-ZY3Q</code> folder. Now, we prepare the sample table by parsing the <code>fcs</code> filenames. For some studies, it might be easier to prepare a <code>sample_table.csv</code> textfile and load it using the <code>readr</code> package.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">fcs_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="kw">path</span> <span class="kw">=</span> <span class="st">"FR-FCM-ZY3Q/"</span>, <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"fcs"</span>)
<span class="no">map_time</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>) {
  <span class="kw">if</span> (<span class="fu">str_detect</span>(<span class="no">x</span>, <span class="st">"_2_"</span>)) <span class="st">"3rd trimester"</span>
  <span class="kw">else</span> <span class="kw">if</span> (<span class="fu">str_detect</span>(<span class="no">x</span>, <span class="st">"_1_"</span>)) <span class="st">"2st trimester"</span>
  <span class="kw">else</span> <span class="kw">if</span> (<span class="fu">str_detect</span>(<span class="no">x</span>, <span class="st">"_BL_"</span>)) <span class="st">"1st trimester"</span>
  <span class="kw">else</span> <span class="fl">NA</span>
}
<span class="no">sample_table</span> <span class="kw">=</span> <span class="fu">tibble</span>(
  <span class="kw">donor</span> <span class="kw">=</span> <span class="fu">str_extract</span>(<span class="no">fcs_files</span>, <span class="st">"PTLG[0-9]{3}"</span>),
  <span class="kw">term</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">fcs_files</span>, <span class="no">map_time</span>) <span class="kw">%&gt;%</span> <span class="no">as.factor</span>,
  <span class="kw">file_name</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"FR-FCM-ZY3Q/"</span>,<span class="no">fcs_files</span>)
)
<span class="no">sample_table</span></pre></body></html></div>
<pre><code>## # A tibble: 48 x 3
##    donor   term          file_name                                
##    &lt;chr&gt;   &lt;fct&gt;         &lt;chr&gt;                                    
##  1 PTLG001 2st trimester FR-FCM-ZY3Q/Gates_PTLG001_1_IFNa_100.fcs 
##  2 PTLG001 3rd trimester FR-FCM-ZY3Q/Gates_PTLG001_2_IFNa_100.fcs 
##  3 PTLG001 1st trimester FR-FCM-ZY3Q/Gates_PTLG001_BL_IFNa_100.fcs
##  4 PTLG002 2st trimester FR-FCM-ZY3Q/Gates_PTLG002_1_IFNa_100.fcs 
##  5 PTLG002 3rd trimester FR-FCM-ZY3Q/Gates_PTLG002_2_IFNa_100.fcs 
##  6 PTLG002 1st trimester FR-FCM-ZY3Q/Gates_PTLG002_BL_IFNa_100.fcs
##  7 PTLG003 2st trimester FR-FCM-ZY3Q/Gates_PTLG003_1_IFNa_100.fcs 
##  8 PTLG003 3rd trimester FR-FCM-ZY3Q/Gates_PTLG003_2_IFNa_100.fcs 
##  9 PTLG003 1st trimester FR-FCM-ZY3Q/Gates_PTLG003_BL_IFNa_100.fcs
## 10 PTLG004 2st trimester FR-FCM-ZY3Q/Gates_PTLG004_1_IFNa_100.fcs 
## # … with 38 more rows</code></pre>
</div>
<div id="marker-table" class="section level2">
<h2 class="hasAnchor">
<a href="#marker-table" class="anchor"></a>Marker Table</h2>
<p>Load marker isotopes and protein names. Make sure that marker names don’t have <code><a href="https://rdrr.io/r/base/Arithmetic.html">-</a></code> or start with a number. This is important to be compatible with the formula syntax of <code>R</code>.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">markers</span> <span class="kw">=</span> <span class="fu">read_csv</span>(<span class="st">"markers.csv"</span>)
<span class="no">markers</span>$<span class="no">protein_name</span> <span class="kw">%&lt;&gt;%</span> <span class="fu">str_replace_all</span>(<span class="st">"-"</span>,<span class="st">"_"</span>)
<span class="no">markers</span>$<span class="no">protein_name</span> <span class="kw">%&lt;&gt;%</span> <span class="no">make.names</span>
<span class="no">markers</span></pre></body></html></div>
<pre><code>## # A tibble: 35 x 3
##    isotope      protein_name type     
##    &lt;chr&gt;        &lt;chr&gt;        &lt;chr&gt;    
##  1 Event_length Event_length none     
##  2 In113Di      CD235ab_CD61 phenotype
##  3 In115Di      CD45         phenotype
##  4 La139Di      CD66         phenotype
##  5 Pr141Di      CD7          phenotype
##  6 Nd142Di      CD19         phenotype
##  7 Nd143Di      CD45RA       phenotype
##  8 Nd144Di      CD11b        phenotype
##  9 Nd145Di      CD4          phenotype
## 10 Nd146Di      CD8a         phenotype
## # … with 25 more rows</code></pre>
<p>Check if bead normalized. This only works if the bead normalizer added an additional column <code>beadDist</code> to the <code>fcs</code>.</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/read.FCS.html">read.FCS</a></span>(<span class="no">sample_table</span>$<span class="no">file_name</span>[<span class="fl">1</span>])) <span class="kw">==</span> <span class="st">"beadDist"</span>)<span class="kw">==</span><span class="fl">1</span>,
       <span class="kw">yes</span> <span class="kw">=</span> <span class="st">"bead normalized"</span>,
       <span class="kw">no</span> <span class="kw">=</span> <span class="st">"not bead normalized"</span>)</pre></body></html></div>
<pre><code>## uneven number of tokens: 571
## The last keyword is dropped.
## uneven number of tokens: 571
## The last keyword is dropped.</code></pre>
<pre><code>## [1] "bead normalized"</code></pre>
</div>
</div>
<div id="gating" class="section level1">
<h1 class="hasAnchor">
<a href="#gating" class="anchor"></a>Gating</h1>
<p>Gate with <a href="https://bioconductor.org/packages/release/bioc/html/openCyto.html">openCyto</a> according to supplementary material (Fig. S1) from <span class="citation">Aghaeepour et al. (2017)</span>.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="co"># load data</span>
<span class="no">ncfs</span> <span class="kw">=</span> <span class="fu">read.ncdfFlowSet</span>(<span class="no">sample_table</span>$<span class="no">file_name</span>, <span class="kw">mc.cores</span> <span class="kw">=</span> <span class="no">ncores</span>)</pre></body></html></div>
<pre><code>## uneven number of tokens: 571
## The last keyword is dropped.
## uneven number of tokens: 571
## The last keyword is dropped.</code></pre>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">gs</span> <span class="kw">=</span> <span class="fu">GatingSet</span>(<span class="no">ncfs</span>)
<span class="fu">pData</span>(<span class="no">gs</span>) <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fu">pData</span>(<span class="no">gs</span>),<span class="no">sample_table</span>)
<span class="no">trans_func</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">asinh</a></span>(<span class="no">x</span>/<span class="fl">5</span>)
<span class="no">inv_func</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="fl">5</span>*<span class="fu"><a href="https://rdrr.io/r/base/Hyperbolic.html">sinh</a></span>(<span class="no">x</span>)
<span class="no">trans_obj</span> <span class="kw">=</span> <span class="fu"><a href="https://scales.r-lib.org//reference/trans_new.html">trans_new</a></span>(<span class="st">"asinh_cytof"</span>, <span class="no">trans_func</span>, <span class="no">inv_func</span>)
<span class="no">translist</span> <span class="kw">=</span> <span class="fu">transformerList</span>(<span class="no">markers</span>$<span class="no">isotope</span>[-<span class="fl">1</span>], <span class="no">trans_obj</span>)
<span class="no">gs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/transform-class.html">transform</a></span>(<span class="no">gs</span>, <span class="no">translist</span>)
<span class="co"># apply gating template</span>
<span class="no">gt_aghaeepour</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/openCyto/man/gatingTemplate-class.html">gatingTemplate</a></span>(<span class="st">"gating_template.csv"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">gt_aghaeepour</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/opencyto-1.png" width="700"></p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/openCyto/man/gt_gating.html">gt_gating</a></span>(<span class="no">gt_aghaeepour</span>, <span class="no">gs</span>, <span class="kw">mc.cores</span> <span class="kw">=</span> <span class="no">ncores</span>, <span class="kw">parallel_type</span> <span class="kw">=</span> <span class="st">"multicore"</span>)
<span class="co"># rename some subsets</span>
<span class="fu">gs_pop_set_name</span>(<span class="no">gs</span>, <span class="st">"/singlet/leukocyte/mononuclear/CD3+CD19-/CD4+CD8a-/CD45RA+"</span>,
                <span class="st">"CD4+Tnaive"</span>) <span class="kw">%&gt;%</span> <span class="no">invisible</span>
<span class="fu">gs_pop_set_name</span>(<span class="no">gs</span>, <span class="st">"/singlet/leukocyte/mononuclear/CD3+CD19-/CD4+CD8a-/CD45RA-"</span>,
                <span class="st">"CD4+Tmem"</span>) <span class="kw">%&gt;%</span> <span class="no">invisible</span>
<span class="fu">gs_pop_set_name</span>(<span class="no">gs</span>, <span class="st">"/singlet/leukocyte/mononuclear/CD3+CD19-/CD4-CD8a+/CD45RA+"</span>,
                <span class="st">"CD8+Tnaive"</span>) <span class="kw">%&gt;%</span> <span class="no">invisible</span>
<span class="fu">gs_pop_set_name</span>(<span class="no">gs</span>, <span class="st">"/singlet/leukocyte/mononuclear/CD3+CD19-/CD4-CD8a+/CD45RA-"</span>,
                <span class="st">"CD8+Tmem"</span>) <span class="kw">%&gt;%</span> <span class="no">invisible</span>
<span class="fu">gs_pop_set_name</span>(<span class="no">gs</span>, <span class="st">"CD3-CD19+"</span>, <span class="st">"B"</span>) <span class="kw">%&gt;%</span> <span class="no">invisible</span>
<span class="fu">gs_pop_set_name</span>(<span class="no">gs</span>, <span class="st">"CD3+CD19-"</span>, <span class="st">"T"</span>) <span class="kw">%&gt;%</span> <span class="no">invisible</span>
<span class="fu">gs_pop_set_name</span>(<span class="no">gs</span>, <span class="st">"CD4+CD8a-"</span>, <span class="st">"CD4+T"</span>) <span class="kw">%&gt;%</span> <span class="no">invisible</span>
<span class="fu">gs_pop_set_name</span>(<span class="no">gs</span>, <span class="st">"CD4-CD8a+"</span>, <span class="st">"CD8+T"</span>) <span class="kw">%&gt;%</span> <span class="no">invisible</span>
<span class="fu">gs_pop_set_name</span>(<span class="no">gs</span>, <span class="st">"CD7+"</span>, <span class="st">"NK"</span>) <span class="kw">%&gt;%</span> <span class="no">invisible</span>
<span class="fu">gs_pop_set_name</span>(<span class="no">gs</span>, <span class="st">"CD14+CD16-"</span>, <span class="st">"cMC"</span>) <span class="kw">%&gt;%</span> <span class="no">invisible</span>
<span class="fu">gs_pop_set_name</span>(<span class="no">gs</span>, <span class="st">"CD14-CD16+"</span>, <span class="st">"ncMC"</span>) <span class="kw">%&gt;%</span> <span class="no">invisible</span>
<span class="fu">gs_pop_set_name</span>(<span class="no">gs</span>, <span class="st">"CD14+CD16+"</span>, <span class="st">"intMC"</span>) <span class="kw">%&gt;%</span> <span class="no">invisible</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">gs</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/opencyto-2.png" width="700"></p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="co"># hide nodes</span>
<span class="no">nodes_to_hide</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
  <span class="st">"granulocyte"</span>, <span class="st">"CD19+"</span>, <span class="st">"CD3+"</span>, <span class="st">"CD3+CD19+"</span>,
  <span class="st">"CD8a+"</span>, <span class="st">"CD4+"</span>, <span class="st">"CD16+"</span>, <span class="st">"CD14+"</span>, <span class="st">"CD14-CD16-"</span>,
  <span class="st">"CD4+CD8a+"</span>, <span class="st">"CD4+Tnaive/CD25+"</span>, <span class="st">"CD4+Tmem/CD25+"</span>,
  <span class="st">"CD4+Tnaive/FoxP3+"</span>, <span class="st">"CD4+Tmem/FoxP3+"</span>
  )
<span class="kw">for</span>(<span class="no">this_node</span> <span class="kw">in</span> <span class="no">nodes_to_hide</span>) <span class="fu">setNode</span>(<span class="no">gs</span>, <span class="no">this_node</span>, <span class="fl">FALSE</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">gs</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/opencyto-3.png" width="700"></p>
<p>Visualize gates with <a href="https://bioconductor.org/packages/release/bioc/html/ggcyto.html">ggcyto</a>.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">0xdada</span>)
<span class="no">ids</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">gs</span>), <span class="kw">size</span> <span class="kw">=</span> <span class="fl">6</span>)
<span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html">ggcyto</a></span>(<span class="no">gs</span>[<span class="no">ids</span>], <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">CD66</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">CD45</span>), <span class="kw">subset</span> <span class="kw">=</span> <span class="st">"leukocyte"</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto_par_set.html">ggcyto_par_set</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="st">"instrument"</span>) + <span class="fu">geom_hex</span>(<span class="kw">bins</span> <span class="kw">=</span> <span class="fl">64</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html">geom_gate</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"mononuclear"</span>,<span class="st">"granulocyte"</span>))</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-1.png" width="700"></p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html">ggcyto</a></span>(<span class="no">gs</span>[<span class="no">ids</span>], <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">CD3</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">CD19</span>), <span class="kw">subset</span> <span class="kw">=</span> <span class="st">"mononuclear"</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto_par_set.html">ggcyto_par_set</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="st">"instrument"</span>) + <span class="fu">geom_hex</span>(<span class="kw">bins</span> <span class="kw">=</span> <span class="fl">64</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html">geom_gate</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"B"</span>,<span class="st">"T"</span>,<span class="st">"CD3-CD19-"</span>))</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-2.png" width="700"></p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html">ggcyto</a></span>(<span class="no">gs</span>[<span class="no">ids</span>], <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">CD14</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">CD7</span>), <span class="kw">subset</span> <span class="kw">=</span> <span class="st">"CD3-CD19-"</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto_par_set.html">ggcyto_par_set</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="st">"instrument"</span>) + <span class="fu">geom_hex</span>(<span class="kw">bins</span> <span class="kw">=</span> <span class="fl">64</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html">geom_gate</a></span>(<span class="st">"NK"</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-3.png" width="700"></p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html">ggcyto</a></span>(<span class="no">gs</span>[<span class="no">ids</span>], <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">CD14</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">CD16</span>), <span class="kw">subset</span> <span class="kw">=</span> <span class="st">"CD7-"</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto_par_set.html">ggcyto_par_set</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="st">"instrument"</span>) + <span class="fu">geom_hex</span>(<span class="kw">bins</span> <span class="kw">=</span> <span class="fl">64</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html">geom_gate</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"cMC"</span>,<span class="st">"ncMC"</span>,<span class="st">"intMC"</span>))</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-4.png" width="700"></p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html">ggcyto</a></span>(<span class="no">gs</span>[<span class="no">ids</span>], <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">CD4</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">CD8a</span>), <span class="kw">subset</span> <span class="kw">=</span> <span class="st">"T"</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto_par_set.html">ggcyto_par_set</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="st">"instrument"</span>) + <span class="fu">geom_hex</span>(<span class="kw">bins</span> <span class="kw">=</span> <span class="fl">64</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html">geom_gate</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"CD4+T"</span>,<span class="st">"CD8+T"</span>,<span class="st">"CD4-CD8a-"</span>))</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-5.png" width="700"></p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html">ggcyto</a></span>(<span class="no">gs</span>[<span class="no">ids</span>], <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">TCRgd</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">CD3</span>), <span class="kw">subset</span> <span class="kw">=</span> <span class="st">"CD4-CD8a-"</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto_par_set.html">ggcyto_par_set</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="st">"instrument"</span>) + <span class="fu">geom_hex</span>(<span class="kw">bins</span> <span class="kw">=</span> <span class="fl">64</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html">geom_gate</a></span>(<span class="st">"gdT"</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-6.png" width="700"></p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html">ggcyto</a></span>(<span class="no">gs</span>[<span class="no">ids</span>], <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">CD4</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">CD45RA</span>), <span class="kw">subset</span> <span class="kw">=</span> <span class="st">"CD4+T"</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto_par_set.html">ggcyto_par_set</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="st">"instrument"</span>) + <span class="fu">geom_hex</span>(<span class="kw">bins</span> <span class="kw">=</span> <span class="fl">64</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html">geom_gate</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"CD4+Tnaive"</span>,<span class="st">"CD4+Tmem"</span>))</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-7.png" width="700"></p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html">ggcyto</a></span>(<span class="no">gs</span>[<span class="no">ids</span>], <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">FoxP3</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">CD25</span>), <span class="kw">subset</span> <span class="kw">=</span> <span class="st">"CD4+Tnaive"</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto_par_set.html">ggcyto_par_set</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="st">"instrument"</span>) + <span class="fu">geom_hex</span>(<span class="kw">bins</span> <span class="kw">=</span> <span class="fl">64</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html">geom_gate</a></span>(<span class="st">"Tregsnaive"</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-8.png" width="700"></p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html">ggcyto</a></span>(<span class="no">gs</span>[<span class="no">ids</span>], <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">FoxP3</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">CD25</span>), <span class="kw">subset</span> <span class="kw">=</span> <span class="st">"CD4+Tmem"</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto_par_set.html">ggcyto_par_set</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="st">"instrument"</span>) + <span class="fu">geom_hex</span>(<span class="kw">bins</span> <span class="kw">=</span> <span class="fl">64</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html">geom_gate</a></span>(<span class="st">"Tregsmem"</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-9.png" width="700"></p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto.html">ggcyto</a></span>(<span class="no">gs</span>[<span class="no">ids</span>], <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">CD8a</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">CD45RA</span>), <span class="kw">subset</span> <span class="kw">=</span> <span class="st">"CD8+T"</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/ggcyto_par_set.html">ggcyto_par_set</a></span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="st">"instrument"</span>) + <span class="fu">geom_hex</span>(<span class="kw">bins</span> <span class="kw">=</span> <span class="fl">64</span>) +
  <span class="fu"><a href="https://rdrr.io/pkg/ggcyto/man/geom_gate.html">geom_gate</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"CD8+Tnaive"</span>,<span class="st">"CD8+Tmem"</span>))</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-10.png" width="700"></p>
<p>Combine cell types of interest into one data frame. Change marker name from isotope name to protein name and remove markers that are unmapped.</p>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="no">nodes_exclude</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"root"</span>,<span class="st">"singlet"</span>,<span class="st">"leukocyte"</span>,<span class="st">"mononuclear"</span>,
                  <span class="st">"CD3-CD19-"</span>,<span class="st">"CD7-"</span>,<span class="st">"CD4-CD8a-"</span>,
                  <span class="st">"CD4+T"</span>,<span class="st">"CD8+T"</span>,<span class="st">"T"</span>)
<span class="no">nodes_all</span> <span class="kw">=</span> <span class="fu">gs_get_pop_paths</span>(<span class="no">gs</span>, <span class="kw">path</span> <span class="kw">=</span> <span class="st">"auto"</span>)
<span class="no">nodes_select</span> <span class="kw">=</span> <span class="no">nodes_all</span>[!<span class="no">nodes_all</span> <span class="kw">%in%</span> <span class="no">nodes_exclude</span>]
<span class="no">df_samples</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">nodes_select</span>, <span class="kw">function</span>(<span class="no">celltype</span>) {
  <span class="no">fset</span> <span class="kw">=</span> <span class="fu">gs_pop_get_data</span>(<span class="no">gs</span>, <span class="no">celltype</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="no">fset</span>), <span class="kw">function</span>(<span class="no">sample_id</span>) {
    <span class="no">marker_ids</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">fset</span>@<span class="kw">origColnames</span> <span class="kw">%in%</span> <span class="no">markers</span>$<span class="no">isotope</span>)
    <span class="no">exprs</span> <span class="kw">=</span> <span class="fu">as_tibble</span>(<span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/flowFrame-class.html">exprs</a></span>(<span class="no">fset</span><span class="kw">[[</span><span class="no">sample_id</span>]]))[,<span class="no">marker_ids</span>]
    <span class="no">file_name</span> <span class="kw">=</span> <span class="fu">pData</span>(<span class="no">fset</span>[<span class="no">sample_id</span>])$<span class="no">file_name</span>
    <span class="no">exprs</span> <span class="kw">%&gt;%</span> <span class="fu">add_column</span>(<span class="no">file_name</span>, <span class="no">celltype</span>)
  }) <span class="kw">%&gt;%</span> <span class="no">bind_rows</span>
}) <span class="kw">%&gt;%</span> <span class="no">bind_rows</span>
<span class="no">df_samples</span> <span class="kw">%&lt;&gt;%</span> <span class="fu">inner_join</span>(<span class="no">sample_table</span>,<span class="kw">by</span> <span class="kw">=</span> <span class="st">"file_name"</span>)
<span class="no">oldnames</span> <span class="kw">=</span> <span class="no">markers</span>$<span class="no">isotope</span>
<span class="no">newnames</span> <span class="kw">=</span> <span class="no">markers</span>$<span class="no">protein_name</span>
<span class="no">df_samples</span> <span class="kw">%&lt;&gt;%</span> <span class="fu">rename_at</span>(<span class="fu">vars</span>(<span class="fu">all_of</span>(<span class="no">oldnames</span>)), ~ <span class="no">newnames</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">df_samples</span>)</pre></body></html></div>
<pre><code>## tibble [3,669,504 × 39] (S3: tbl_df/tbl/data.frame)
##  $ Event_length: num [1:3669504] 33 26 21 51 55 32 66 27 35 55 ...
##  $ CD235ab_CD61: num [1:3669504] 0 0.0736 0.3772 0 0 ...
##  $ CD45        : num [1:3669504] 4.08 4.13 5.03 4.47 4.68 ...
##  $ CD66        : num [1:3669504] 0.538 1.082 1.312 0.261 1.083 ...
##  $ CD7         : num [1:3669504] 5.2 4.08 4.63 5.39 6.05 ...
##  $ CD19        : num [1:3669504] 0.134 0.169 1.176 1.116 0.199 ...
##  $ CD45RA      : num [1:3669504] 4.237 3.443 3.842 4.319 0.241 ...
##  $ CD11b       : num [1:3669504] 2.7 2.07 1.92 2.49 1.9 ...
##  $ CD4         : num [1:3669504] 0.2652 0 0 0.0955 0.1431 ...
##  $ CD8a        : num [1:3669504] 0.2344 0.0158 0.7656 0 0.2404 ...
##  $ CD11c       : num [1:3669504] 2.184 2.21 1.91 0.213 2.85 ...
##  $ CD123       : num [1:3669504] 0.0249 0 0.0688 0.3725 0.0723 ...
##  $ pCREB       : num [1:3669504] 1.526 1.36 1.668 0.947 0.812 ...
##  $ pSTAT5      : num [1:3669504] 2.19 1.16 1.54 1.68 2.02 ...
##  $ pP38        : num [1:3669504] 0.286 0.348 0.797 0.862 0.724 ...
##  $ TCRgd       : num [1:3669504] 0.3318 0.2139 0 0.0761 0 ...
##  $ pSTAT1      : num [1:3669504] 3.46 2.7 3.77 3.14 2.92 ...
##  $ pSTAT3      : num [1:3669504] 2.27 2.22 1.75 2.07 2.13 ...
##  $ prpS6       : num [1:3669504] 1.234 0.439 0.296 1.481 0 ...
##  $ CD33        : num [1:3669504] 1.2231 0.0593 0.1261 0.6798 0.6141 ...
##  $ pMAPKAPK    : num [1:3669504] 1.78 2.01 2.51 2.51 1.95 ...
##  $ Tbet2       : num [1:3669504] 2.24 2.74 3.76 3.08 2.59 ...
##  $ FoxP3       : num [1:3669504] 0.947 0.471 0.489 1.066 0.901 ...
##  $ IkB         : num [1:3669504] 1.024 0.906 1.075 1.161 1.343 ...
##  $ CD16        : num [1:3669504] 0.1013 0.1794 0 0.144 0.0644 ...
##  $ pNFkB       : num [1:3669504] 1.121 1.712 0.945 2.037 1.435 ...
##  $ pERK1_2     : num [1:3669504] 0.1168 0 0.2711 0 0.0282 ...
##  $ CD25        : num [1:3669504] 0 0 0.183 0.243 0 ...
##  $ CD3         : num [1:3669504] 0.364 0 0 0 0 ...
##  $ CD15        : num [1:3669504] 0.115 0.946 0.367 0.248 0.497 ...
##  $ HLA_DR      : num [1:3669504] 2.127 1.535 0.201 0.531 1.101 ...
##  $ CD14        : num [1:3669504] 0.143 0 0 0 0 ...
##  $ CD56        : num [1:3669504] 4.82 2.8 3.68 3.89 5.25 ...
##  $ DNA1        : num [1:3669504] 3.33 3.83 4.36 3.76 3.87 ...
##  $ DNA2        : num [1:3669504] 4.2 4.25 4.9 4.44 4.55 ...
##  $ file_name   : chr [1:3669504] "FR-FCM-ZY3Q/Gates_PTLG001_1_IFNa_100.fcs" "FR-FCM-ZY3Q/Gates_PTLG001_1_IFNa_100.fcs" "FR-FCM-ZY3Q/Gates_PTLG001_1_IFNa_100.fcs" "FR-FCM-ZY3Q/Gates_PTLG001_1_IFNa_100.fcs" ...
##  $ celltype    : chr [1:3669504] "NK" "NK" "NK" "NK" ...
##  $ donor       : chr [1:3669504] "PTLG001" "PTLG001" "PTLG001" "PTLG001" ...
##  $ term        : Factor w/ 3 levels "1st trimester",..: 2 2 2 2 2 2 2 2 2 2 ...
##   ..- attr(*, "names")= chr [1:3669504] "Gates_PTLG001_1_IFNa_100.fcs" "Gates_PTLG001_1_IFNa_100.fcs" "Gates_PTLG001_1_IFNa_100.fcs" "Gates_PTLG001_1_IFNa_100.fcs" ...</code></pre>
<p>List cell counts per donor and trimester.</p>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span>(<span class="no">df_samples</span>$<span class="no">donor</span>,<span class="no">df_samples</span>$<span class="no">term</span>)</pre></body></html></div>
<pre><code>##          
##           1st trimester 2st trimester 3rd trimester
##   PTLG001         82937         61408         80265
##   PTLG002         66573         92982         74721
##   PTLG003        108142         80475         75041
##   PTLG004         48169         66194         57682
##   PTLG005         81455         79486         87003
##   PTLG007        115016         98249        135821
##   PTLG008         83824         88448         73391
##   PTLG009        103724         83306         96440
##   PTLG010         58504         68719         76391
##   PTLG012         72357         62635         68484
##   PTLG018         66348         86527         92544
##   PTLG019         78024         74177         71328
##   PTLG020         44037         37367         49138
##   PTLG022         89129         52931         70198
##   PTLG024        117099         77125         79094
##   PTLG029         54313         56368         45915</code></pre>
<p>Plot abundance of each celltype per sample.</p>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="no">df_abundance</span> <span class="kw">=</span> <span class="no">df_samples</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">file_name</span>, <span class="no">donor</span>, <span class="no">term</span>, <span class="no">celltype</span>) <span class="kw">%&gt;%</span>
  <span class="fu">tally</span>()
<span class="fu">ggplot</span>(<span class="no">df_abundance</span>, <span class="fu">aes</span>(<span class="no">term</span>, <span class="no">n</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">term</span>)) +
  <span class="fu">geom_violin</span>() +
  <span class="fu">geom_jitter</span>(<span class="kw">width</span> <span class="kw">=</span> <span class="fl">0.2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">facet_wrap</span>(~<span class="no">celltype</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu">theme</span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu">element_blank</span>())</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/cell_abundance-1.png" width="700"></p>
<p>Focus on functional proteins.</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="no">protein_names</span> <span class="kw">=</span> <span class="no">markers</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">type</span> <span class="kw">==</span> <span class="st">"function"</span>) <span class="kw">%&gt;%</span>
  <span class="no">.</span>$<span class="no">protein_name</span>
<span class="no">protein_names</span></pre></body></html></div>
<pre><code>##  [1] "pCREB"    "pSTAT5"   "pP38"     "pSTAT1"   "pSTAT3"   "prpS6"   
##  [7] "pMAPKAPK" "IkB"      "pNFkB"    "pERK1_2"</code></pre>
<p>Declare the columns in <code>df_samples</code> that are not protein markers. In our example, we have donor ID, time point when the sample was collected, <code>FCS</code> filename, and the cell type that we have defined through gating.</p>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">sample_info_names</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/flowCore/man/flowFrame-class.html">names</a></span>(<span class="no">sample_table</span>),<span class="st">"celltype"</span>)
<span class="no">sample_info_names</span></pre></body></html></div>
<pre><code>## [1] "donor"     "term"      "file_name" "celltype"</code></pre>
</div>
<div id="data-exploration" class="section level1">
<h1 class="hasAnchor">
<a href="#data-exploration" class="anchor"></a>Data Exploration</h1>
<div id="mds" class="section level2">
<h2 class="hasAnchor">
<a href="#mds" class="anchor"></a>MDS</h2>
<p>MDS on median marker expression of all cell types following <span class="citation">Nowicka et al. (2017)</span>.</p>
<div class="sourceCode" id="cb36"><html><body><pre class="r"><span class="kw pkg">CytoGLMM</span><span class="kw ns">::</span><span class="fu"><a href="../reference/plot_mds.html">plot_mds</a></span>(<span class="no">df_samples</span>,
                   <span class="kw">protein_names</span> <span class="kw">=</span> <span class="no">protein_names</span>,
                   <span class="kw">sample_info_names</span> <span class="kw">=</span> <span class="no">sample_info_names</span>,
                   <span class="kw">color</span> <span class="kw">=</span> <span class="st">"celltype"</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/plot_mds_celltype-1.png" width="700"></p>
<p>Subset to NK cells to illustrate visualization for one cell type.</p>
<div class="sourceCode" id="cb37"><html><body><pre class="r"><span class="no">df_samples_subset</span> <span class="kw">=</span> <span class="no">df_samples</span> <span class="kw">%&gt;%</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">celltype</span> <span class="kw">==</span> <span class="st">"NK"</span>)</pre></body></html></div>
<p>MDS on median marker expression of NK cells.</p>
<div class="sourceCode" id="cb38"><html><body><pre class="r"><span class="kw pkg">CytoGLMM</span><span class="kw ns">::</span><span class="fu"><a href="../reference/plot_mds.html">plot_mds</a></span>(<span class="no">df_samples_subset</span>,
                   <span class="kw">protein_names</span> <span class="kw">=</span> <span class="no">protein_names</span>,
                   <span class="kw">sample_info_names</span> <span class="kw">=</span> <span class="no">sample_info_names</span>,
                   <span class="kw">color</span> <span class="kw">=</span> <span class="st">"term"</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/plot_mds_nk-1.png" width="700"></p>
</div>
<div id="heatmap" class="section level2">
<h2 class="hasAnchor">
<a href="#heatmap" class="anchor"></a>Heatmap</h2>
<p>Heatmap of median marker expression of all cell types following <span class="citation">Nowicka et al. (2017)</span>.</p>
<div class="sourceCode" id="cb39"><html><body><pre class="r"><span class="kw pkg">CytoGLMM</span><span class="kw ns">::</span><span class="fu"><a href="../reference/plot_heatmap.html">plot_heatmap</a></span>(<span class="no">df_samples</span>,
                       <span class="kw">protein_names</span> <span class="kw">=</span> <span class="no">protein_names</span>,
                       <span class="kw">sample_info_names</span> <span class="kw">=</span> <span class="no">sample_info_names</span>,
                       <span class="kw">arrange_by_1</span> <span class="kw">=</span> <span class="st">"term"</span>,
                       <span class="kw">arrange_by_2</span> <span class="kw">=</span> <span class="st">"celltype"</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/plot_heatmap_celltype-1.png" width="700"></p>
<p>Heatmap of median marker expression of NK cells.</p>
<div class="sourceCode" id="cb40"><html><body><pre class="r"><span class="kw pkg">CytoGLMM</span><span class="kw ns">::</span><span class="fu"><a href="../reference/plot_heatmap.html">plot_heatmap</a></span>(<span class="no">df_samples_subset</span>,
                       <span class="kw">protein_names</span> <span class="kw">=</span> <span class="no">protein_names</span>,
                       <span class="kw">sample_info_names</span> <span class="kw">=</span> <span class="no">sample_info_names</span>,
                       <span class="kw">arrange_by_1</span> <span class="kw">=</span> <span class="st">"term"</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/plot_heatmap_nk-1.png" width="700"></p>
</div>
<div id="pca" class="section level2">
<h2 class="hasAnchor">
<a href="#pca" class="anchor"></a>PCA</h2>
<p>PCA plot of all cell types.</p>
<div class="sourceCode" id="cb41"><html><body><pre class="r"><span class="kw pkg">CytoGLMM</span><span class="kw ns">::</span><span class="fu"><a href="../reference/plot_prcomp.html">plot_prcomp</a></span>(<span class="no">df_samples</span>,
                      <span class="kw">protein_names</span> <span class="kw">=</span> <span class="no">protein_names</span>,
                      <span class="kw">color_var</span> <span class="kw">=</span> <span class="st">"celltype"</span>,
                      <span class="kw">repel</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/plot_prcomp_celltype-1.png" width="700"></p>
<p>PCA plot of NK cells.</p>
<div class="sourceCode" id="cb42"><html><body><pre class="r"><span class="kw pkg">CytoGLMM</span><span class="kw ns">::</span><span class="fu"><a href="../reference/plot_prcomp.html">plot_prcomp</a></span>(<span class="no">df_samples_subset</span>,
                      <span class="kw">protein_names</span> <span class="kw">=</span> <span class="no">protein_names</span>,
                      <span class="kw">color_var</span> <span class="kw">=</span> <span class="st">"term"</span>,
                      <span class="kw">repel</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/plot_prcomp_nk-1.png" width="700"></p>
</div>
<div id="lda" class="section level2">
<h2 class="hasAnchor">
<a href="#lda" class="anchor"></a>LDA</h2>
<p>LDA plot of NK cells.</p>
<div class="sourceCode" id="cb43"><html><body><pre class="r"><span class="kw pkg">CytoGLMM</span><span class="kw ns">::</span><span class="fu"><a href="../reference/plot_lda.html">plot_lda</a></span>(<span class="no">df_samples_subset</span>,
                   <span class="no">protein_names</span>,
                   <span class="kw">group</span> <span class="kw">=</span> <span class="st">"term"</span>,
                   <span class="kw">cor_scaling_factor</span> <span class="kw">=</span> <span class="fl">2.5</span>,
                   <span class="kw">arrow_color</span> <span class="kw">=</span> <span class="st">"black"</span>,
                   <span class="kw">marker_color</span> <span class="kw">=</span> <span class="st">"black"</span>,
                   <span class="kw">marker_size</span> <span class="kw">=</span> <span class="fl">4</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/plot_lda_nk-1.png" width="700"></p>
</div>
<div id="density-plots" class="section level2">
<h2 class="hasAnchor">
<a href="#density-plots" class="anchor"></a>Density Plots</h2>
<p>Density plots of one marker for all donors.</p>
<div class="sourceCode" id="cb44"><html><body><pre class="r"><span class="fu">ggplot</span>(<span class="no">df_samples_subset</span>, <span class="fu">aes_string</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"pCREB"</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">"term"</span>)) +
  <span class="fu">geom_density</span>() +
  <span class="fu">facet_wrap</span>(~<span class="no">donor</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/density_plot-1.png" width="700"></p>
</div>
<div id="two-dimensional-histograms" class="section level2">
<h2 class="hasAnchor">
<a href="#two-dimensional-histograms" class="anchor"></a>Two-Dimensional Histograms</h2>
<p>Two-dimensional histograms for plotting two markers for all donors.</p>
<div class="sourceCode" id="cb45"><html><body><pre class="r"><span class="no">colorscale</span> <span class="kw">=</span> <span class="fu">scale_fill_gradientn</span>(
  <span class="kw">colors</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html">rev</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html">brewer.pal</a></span>(<span class="fl">9</span>, <span class="st">"YlGnBu"</span>)),
  <span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(-<span class="fl">5</span>, <span class="fl">0</span>, <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">100</span>)))
  )
<span class="fu">ggplot</span>(<span class="no">df_samples_subset</span>, <span class="fu">aes_string</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"pSTAT1"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"pSTAT3"</span>)) +
  <span class="fu">geom_hex</span>(<span class="kw">bins</span> <span class="kw">=</span> <span class="fl">64</span>) +
  <span class="no">colorscale</span> +
  <span class="fu">coord_fixed</span>() +
  <span class="fu">facet_wrap</span>(~<span class="no">donor</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/hist2_donors-1.png" width="700"></p>
<p>Two-dimensional histograms for group comparisons.</p>
<div class="sourceCode" id="cb46"><html><body><pre class="r"><span class="fu">ggplot</span>(<span class="no">df_samples_subset</span>, <span class="fu">aes_string</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"pSTAT1"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"pSTAT3"</span>)) +
  <span class="fu">geom_hex</span>(<span class="kw">bins</span> <span class="kw">=</span> <span class="fl">64</span>) +
  <span class="no">colorscale</span> +
  <span class="fu">coord_fixed</span>() +
  <span class="fu">facet_wrap</span>(~<span class="no">term</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/hist2_groups-1.png" width="700"></p>
<p>NK cell count. List the smallest and largest.</p>
<div class="sourceCode" id="cb47"><html><body><pre class="r"><span class="no">df_samples_subset</span> <span class="kw">%&gt;%</span> <span class="fu">group_by</span>(<span class="no">term</span>,<span class="no">donor</span>) <span class="kw">%&gt;%</span> <span class="no">tally</span> <span class="kw">%&gt;%</span> <span class="fu">arrange</span>(<span class="no">n</span>)</pre></body></html></div>
<pre><code>## # A tibble: 48 x 3
## # Groups:   term [3]
##    term          donor       n
##    &lt;fct&gt;         &lt;chr&gt;   &lt;int&gt;
##  1 2st trimester PTLG020  1759
##  2 3rd trimester PTLG024  2380
##  3 2st trimester PTLG024  2738
##  4 2st trimester PTLG001  2910
##  5 3rd trimester PTLG001  3125
##  6 3rd trimester PTLG020  3230
##  7 1st trimester PTLG020  3412
##  8 1st trimester PTLG001  3474
##  9 3rd trimester PTLG009  3764
## 10 2st trimester PTLG009  4004
## # … with 38 more rows</code></pre>
<div class="sourceCode" id="cb49"><html><body><pre class="r"><span class="no">df_samples_subset</span> <span class="kw">%&gt;%</span> <span class="fu">group_by</span>(<span class="no">term</span>,<span class="no">donor</span>) <span class="kw">%&gt;%</span> <span class="no">tally</span> <span class="kw">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(<span class="no">n</span>))</pre></body></html></div>
<pre><code>## # A tibble: 48 x 3
## # Groups:   term [3]
##    term          donor       n
##    &lt;fct&gt;         &lt;chr&gt;   &lt;int&gt;
##  1 2st trimester PTLG008 13956
##  2 1st trimester PTLG008 13395
##  3 2st trimester PTLG029  9104
##  4 2st trimester PTLG002  9037
##  5 1st trimester PTLG022  8222
##  6 1st trimester PTLG003  8087
##  7 3rd trimester PTLG008  7953
##  8 2st trimester PTLG018  7781
##  9 3rd trimester PTLG018  7620
## 10 2st trimester PTLG004  7579
## # … with 38 more rows</code></pre>
</div>
<div id="marker-correlations" class="section level2">
<h2 class="hasAnchor">
<a href="#marker-correlations" class="anchor"></a>Marker Correlations</h2>
<p>Plot marker correlations.</p>
<div class="sourceCode" id="cb51"><html><body><pre class="r"><span class="no">mcor</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(<span class="no">df_samples_subset</span> <span class="kw">%&gt;%</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">protein_names</span>))
<span class="fu"><a href="https://rdrr.io/pkg/ggcorrplot/man/ggcorrplot.html">ggcorrplot</a></span>(<span class="no">mcor</span>, <span class="kw">hc.order</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">type</span> <span class="kw">=</span> <span class="st">"lower"</span>,
           <span class="kw">outline.col</span> <span class="kw">=</span> <span class="st">"lightgray"</span>,
           <span class="kw">colors</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"#6D9EC1"</span>, <span class="st">"white"</span>, <span class="st">"#E46726"</span>))</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/marker_correlations-1.png" width="700"></p>
</div>
</div>
<div id="regression-analysis-on-summarized-data" class="section level1">
<h1 class="hasAnchor">
<a href="#regression-analysis-on-summarized-data" class="anchor"></a>Regression Analysis on Summarized Data</h1>
<p>Classical differential analysis approach comparing median marker expressions <span class="citation">(Nowicka et al. 2017)</span>.</p>
<div id="plot-median-marker-expression" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-median-marker-expression" class="anchor"></a>Plot Median Marker Expression</h2>
<p>Plot all celltypes.</p>
<div class="sourceCode" id="cb52"><html><body><pre class="r"><span class="no">df_median</span> <span class="kw">=</span> <span class="no">df_samples</span> <span class="kw">%&gt;%</span>
      <span class="fu">group_by</span>(<span class="no">file_name</span>, <span class="no">donor</span>, <span class="no">term</span>, <span class="no">celltype</span>) <span class="kw">%&gt;%</span>
      <span class="fu">summarise_at</span>(<span class="no">protein_names</span>, <span class="no">median</span>)
<span class="no">df_median_long</span> <span class="kw">=</span> <span class="fu">gather</span>(<span class="no">df_median</span>, <span class="no">protein_name</span>, <span class="no">median_expr</span>,
                        -<span class="no">file_name</span>, -<span class="no">donor</span>, -<span class="no">term</span>, -<span class="no">celltype</span>)
<span class="fu">ggplot</span>(<span class="no">df_median_long</span>, <span class="fu">aes</span>(<span class="no">protein_name</span>, <span class="no">median_expr</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">term</span>)) +
  <span class="fu">geom_violin</span>() +
  <span class="fu">facet_wrap</span>(~<span class="no">celltype</span>) +
  <span class="fu">theme</span>(<span class="kw">axis.text.x</span>  <span class="kw">=</span> <span class="fu">element_text</span>(<span class="kw">angle</span> <span class="kw">=</span> <span class="fl">90</span>, <span class="kw">vjust</span><span class="kw">=</span><span class="fl">0</span>))</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/median_expression_plot-1.png" width="700"></p>
<p>Zoom in on NK cells.</p>
<div class="sourceCode" id="cb53"><html><body><pre class="r"><span class="no">df_median_long</span> <span class="kw">%&lt;&gt;%</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">celltype</span> <span class="kw">==</span> <span class="st">"NK"</span>)
<span class="fu">ggplot</span>(<span class="no">df_median_long</span>, <span class="fu">aes</span>(<span class="no">term</span>, <span class="no">median_expr</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">term</span>)) +
  <span class="fu">geom_violin</span>() +
  <span class="fu">geom_jitter</span>(<span class="kw">width</span> <span class="kw">=</span> <span class="fl">0.2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">facet_wrap</span>(~ <span class="no">protein_name</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu">theme</span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu">element_blank</span>()) +
  <span class="fu">ggtitle</span>(<span class="st">"NK"</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/median_expression_plot_nk-1.png" width="700"></p>
<p>Zoom in on marker pSTAT1.</p>
<div class="sourceCode" id="cb54"><html><body><pre class="r"><span class="fu">ggplot</span>(<span class="no">df_median</span>, <span class="fu">aes</span>(<span class="no">term</span>, <span class="no">pSTAT1</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">term</span>)) +
  <span class="fu">geom_violin</span>() +
  <span class="fu">geom_jitter</span>(<span class="kw">width</span> <span class="kw">=</span> <span class="fl">0.2</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">facet_wrap</span>(~<span class="no">celltype</span>, <span class="kw">nrow</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu">theme</span>(<span class="kw">axis.text.x</span> <span class="kw">=</span> <span class="fu">element_blank</span>())</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/median_expression_plot_pstat1-1.png" width="700"></p>
</div>
<div id="linear-mixed-model" class="section level2">
<h2 class="hasAnchor">
<a href="#linear-mixed-model" class="anchor"></a>Linear Mixed Model</h2>
<p>Mixed model with median expression as response variable, experimental condition as explanatory variable, and donor as random effect. Fit separate models for each protein and celltype combination.</p>
<div class="sourceCode" id="cb55"><html><body><pre class="r"><span class="no">calc_pvalue</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">fit</span>) {
  <span class="no">summ</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">fit</span>)
  <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coefficients</a></span>(<span class="no">summ</span>)[<span class="st">"term3rd trimester"</span>, <span class="st">"Pr(&gt;|t|)"</span>]
}
<span class="no">df_median_long</span> <span class="kw">=</span> <span class="fu">gather</span>(<span class="no">df_median</span>, <span class="no">protein_name</span>, <span class="no">median_expr</span>,
                        -<span class="no">file_name</span>, -<span class="no">donor</span>, -<span class="no">term</span>, -<span class="no">celltype</span>)
<span class="no">df_fits</span> <span class="kw">=</span> <span class="no">df_median_long</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">protein_name</span>, <span class="no">celltype</span>) <span class="kw">%&gt;%</span>
  <span class="fu">nest</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">fit</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="no">data</span>, ~ <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span>(<span class="no">median_expr</span> ~ <span class="no">term</span> + (<span class="fl">1</span><span class="kw">|</span><span class="no">donor</span>), <span class="no">.</span>))) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">pvalue_unadj</span> <span class="kw">=</span> <span class="fu">map_dbl</span>(<span class="no">fit</span>, ~ <span class="fu">calc_pvalue</span>(<span class="no">.</span>))) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">pvalue_adj</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span>(<span class="no">pvalue_unadj</span>, <span class="kw">method</span> <span class="kw">=</span> <span class="st">"BH"</span>)) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">protein_name</span>, <span class="no">celltype</span>, <span class="no">pvalue_adj</span>)
<span class="no">df_fits</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">pvalue_adj</span> <span class="kw">&lt;</span> <span class="fl">0.05</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(<span class="no">celltype</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fl">Inf</span>)</pre></body></html></div>
<pre><code>## # A tibble: 45 x 3
## # Groups:   celltype, protein_name [45]
##    protein_name celltype      pvalue_adj
##    &lt;chr&gt;        &lt;chr&gt;              &lt;dbl&gt;
##  1 pSTAT1       B          0.00223      
##  2 pMAPKAPK     B          0.0297       
##  3 pNFkB        B          0.0115       
##  4 pERK1_2      B          0.0310       
##  5 pSTAT5       CD4+Tmem   0.0194       
##  6 pSTAT1       CD4+Tmem   0.0000128    
##  7 IkB          CD4+Tmem   0.0183       
##  8 pNFkB        CD4+Tmem   0.0000356    
##  9 pERK1_2      CD4+Tmem   0.00748      
## 10 pCREB        CD4+Tnaive 0.00146      
## 11 pSTAT5       CD4+Tnaive 0.000983     
## 12 pP38         CD4+Tnaive 0.0311       
## 13 pSTAT1       CD4+Tnaive 0.0000829    
## 14 prpS6        CD4+Tnaive 0.0184       
## 15 IkB          CD4+Tnaive 0.000118     
## 16 pNFkB        CD4+Tnaive 0.0000421    
## 17 pSTAT5       CD8+Tmem   0.0364       
## 18 pSTAT1       CD8+Tmem   0.0000946    
## 19 pSTAT3       CD8+Tmem   0.0440       
## 20 pNFkB        CD8+Tmem   0.00662      
## 21 pERK1_2      CD8+Tmem   0.0142       
## 22 pCREB        CD8+Tnaive 0.0164       
## 23 pSTAT5       CD8+Tnaive 0.00223      
## 24 pP38         CD8+Tnaive 0.0437       
## 25 pSTAT1       CD8+Tnaive 0.00000453   
## 26 prpS6        CD8+Tnaive 0.00421      
## 27 pMAPKAPK     CD8+Tnaive 0.0328       
## 28 IkB          CD8+Tnaive 0.00618      
## 29 pNFkB        CD8+Tnaive 0.000159     
## 30 pERK1_2      CD8+Tnaive 0.0356       
## 31 pSTAT1       cMC        0.000489     
## 32 pNFkB        cMC        0.0232       
## 33 pSTAT1       gdT        0.0236       
## 34 prpS6        gdT        0.0452       
## 35 prpS6        intMC      0.0374       
## 36 pSTAT5       ncMC       0.0454       
## 37 IkB          ncMC       0.0204       
## 38 pERK1_2      ncMC       0.0175       
## 39 pSTAT1       NK         0.00000000684
## 40 pNFkB        NK         0.00126      
## 41 pERK1_2      NK         0.00281      
## 42 pSTAT1       Tregsmem   0.000276     
## 43 pNFkB        Tregsmem   0.0158       
## 44 pSTAT1       Tregsnaive 0.00517      
## 45 pNFkB        Tregsnaive 0.0159</code></pre>
</div>
</div>
<div id="regression-analysis-on-all-the-data" class="section level1">
<h1 class="hasAnchor">
<a href="#regression-analysis-on-all-the-data" class="anchor"></a>Regression Analysis on All The Data</h1>
<p>For the regression analysis, we will focus only on NK cells, and compare the first and third trimester. We can repeat the same analysis for each cell type of interest, and trimester combination.</p>
<div class="sourceCode" id="cb57"><html><body><pre class="r"><span class="no">df_samples_subset</span> <span class="kw">%&lt;&gt;%</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">term</span> <span class="kw">!=</span> <span class="st">"2st trimester"</span>)
<span class="no">df_samples_subset</span>$<span class="no">term</span> <span class="kw">%&lt;&gt;%</span> <span class="no">droplevels</span>
<span class="no">df_samples_subset</span>$<span class="no">term</span> <span class="kw">%&lt;&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">levels</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"1st trimester"</span>,
                                              <span class="st">"3rd trimester"</span>))</pre></body></html></div>
<div id="generalized-linear-mixed-model" class="section level2">
<h2 class="hasAnchor">
<a href="#generalized-linear-mixed-model" class="anchor"></a>Generalized Linear Mixed Model</h2>
<p>Fit a Generalized Linear Mixed Model (GLMM) with donor random effects. This function is a wrapper around the package <code>mbest</code> <span class="citation">(Perry 2017)</span>.</p>
<div class="sourceCode" id="cb58"><html><body><pre class="r"><span class="no">glmm_fit</span> <span class="kw">=</span> <span class="kw pkg">CytoGLMM</span><span class="kw ns">::</span><span class="fu"><a href="../reference/cytoglmm.html">cytoglmm</a></span>(<span class="no">df_samples_subset</span>,
                              <span class="kw">protein_names</span> <span class="kw">=</span> <span class="no">protein_names</span>,
                              <span class="kw">condition</span> <span class="kw">=</span> <span class="st">"term"</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="st">"donor"</span>)</pre></body></html></div>
<pre><code>## 2020-12-11 22:58:31 INFO:mbest.mhglm:Creating design matrix
## 2020-12-11 22:58:31 INFO:mbest.mhglm:Grouping factor and random effect design matrix
## 2020-12-11 22:58:31 INFO:mbest.mhglm:Setting weights
## 2020-12-11 22:58:31 INFO:mbest.mhglm:Setting offset
## 2020-12-11 22:58:31 INFO:mbest.mhglm:Fitting model
## 2020-12-11 22:58:31 INFO:mbest.mhglm.fit:Fitting models in parallel
## 2020-12-11 22:58:33 INFO:mbest.mhglm.fit:Computing mean and covariance estimates
## 2020-12-11 22:58:33 INFO:mbest.mhglm.fit:Estimating moments
## 2020-12-11 22:58:33 INFO:mbest.mhglm.fit:Computing mean estimate
## 2020-12-11 22:58:33 INFO:mbest.mhglm.fit:Computing covariance estimate
## 2020-12-11 22:58:33 INFO:mbest.mhglm.fit:Refining mean and covariance estimates
## 2020-12-11 22:58:33 INFO:mbest.mhglm.fit:Estimating moments
## 2020-12-11 22:58:33 INFO:mbest.mhglm.fit:Computing mean estimate
## 2020-12-11 22:58:33 INFO:mbest.mhglm.fit:Computing covariance estimate</code></pre>
<div class="sourceCode" id="cb60"><html><body><pre class="r"><span class="no">glmm_fit</span></pre></body></html></div>
<pre><code>## number of cells per group and condition:         
##           1st trimester 3rd trimester
##   PTLG001          3474          3125
##   PTLG002          5438          6120
##   PTLG003          8087          5035
##   PTLG004          4991          6501
##   PTLG005          6105          5074
##   PTLG007          5766          5302
##   PTLG008         13395          7953
##   PTLG009          5177          3764
##   PTLG010          4273          4908
##   PTLG012          6624          5643
##   PTLG018          4083          7620
##   PTLG019          6671          4542
##   PTLG020          3412          3230
##   PTLG022          8222          5709
##   PTLG024          4100          2380
##   PTLG029          7211          4937
## 
## proteins included in the analysis:
##  pCREB pSTAT5 pP38 pSTAT1 pSTAT3 prpS6 pMAPKAPK IkB pNFkB pERK1_2 
## 
## condition compared: term 
## grouping variable: donor</code></pre>
<div class="sourceCode" id="cb62"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">glmm_fit</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/glmm_fit-1.png" width="700"></p>
<div class="sourceCode" id="cb63"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">glmm_fit</span>) <span class="kw">%&gt;%</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">pvalues_adj</span> <span class="kw">&lt;</span> <span class="fl">0.05</span>)</pre></body></html></div>
<pre><code>## # A tibble: 3 x 3
##   protein_name pvalues_unadj pvalues_adj
##   &lt;chr&gt;                &lt;dbl&gt;       &lt;dbl&gt;
## 1 pSTAT3            6.18e-21    6.18e-20
## 2 pSTAT1            6.58e-19    3.29e-18
## 3 pSTAT5            7.47e- 9    2.49e- 8</code></pre>
<p>Add pSTAT1, pSTAT3, and pSTAT5 into one marker.</p>
<div class="sourceCode" id="cb65"><html><body><pre class="r"><span class="no">df_samples_subset</span> <span class="kw">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="kw">pSTAT_sum</span> <span class="kw">=</span> <span class="no">pSTAT1</span>+<span class="no">pSTAT3</span>+<span class="no">pSTAT5</span>)
<span class="no">protein_names_sum</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
  <span class="st">"pSTAT_sum"</span>,
  <span class="no">protein_names</span>[!<span class="no">protein_names</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"pSTAT1"</span>,<span class="st">"pSTAT3"</span>,<span class="st">"pSTAT5"</span>)]
)
<span class="no">glmm_fit</span> <span class="kw">=</span> <span class="kw pkg">CytoGLMM</span><span class="kw ns">::</span><span class="fu"><a href="../reference/cytoglmm.html">cytoglmm</a></span>(<span class="no">df_samples_subset</span>,
                              <span class="kw">protein_names</span> <span class="kw">=</span> <span class="no">protein_names_sum</span>,
                              <span class="kw">condition</span> <span class="kw">=</span> <span class="st">"term"</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="st">"donor"</span>)</pre></body></html></div>
<pre><code>## 2020-12-11 22:58:33 INFO:mbest.mhglm:Creating design matrix
## 2020-12-11 22:58:33 INFO:mbest.mhglm:Grouping factor and random effect design matrix
## 2020-12-11 22:58:33 INFO:mbest.mhglm:Setting weights
## 2020-12-11 22:58:33 INFO:mbest.mhglm:Setting offset
## 2020-12-11 22:58:33 INFO:mbest.mhglm:Fitting model
## 2020-12-11 22:58:33 INFO:mbest.mhglm.fit:Fitting models in parallel
## 2020-12-11 22:58:35 INFO:mbest.mhglm.fit:Computing mean and covariance estimates
## 2020-12-11 22:58:35 INFO:mbest.mhglm.fit:Estimating moments
## 2020-12-11 22:58:35 INFO:mbest.mhglm.fit:Computing mean estimate
## 2020-12-11 22:58:35 INFO:mbest.mhglm.fit:Computing covariance estimate
## 2020-12-11 22:58:35 INFO:mbest.mhglm.fit:Refining mean and covariance estimates
## 2020-12-11 22:58:35 INFO:mbest.mhglm.fit:Estimating moments
## 2020-12-11 22:58:35 INFO:mbest.mhglm.fit:Computing mean estimate
## 2020-12-11 22:58:35 INFO:mbest.mhglm.fit:Computing covariance estimate</code></pre>
<div class="sourceCode" id="cb67"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">glmm_fit</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/glmm_fit_combine-1.png" width="700"></p>
<div class="sourceCode" id="cb68"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">glmm_fit</span>) <span class="kw">%&gt;%</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">pvalues_adj</span> <span class="kw">&lt;</span> <span class="fl">0.05</span>)</pre></body></html></div>
<pre><code>## # A tibble: 1 x 3
##   protein_name pvalues_unadj pvalues_adj
##   &lt;chr&gt;                &lt;dbl&gt;       &lt;dbl&gt;
## 1 pSTAT_sum      0.000000189  0.00000151</code></pre>
<p>Take differences between pSTAT1, pSTAT3, and pSTAT5.</p>
<div class="sourceCode" id="cb70"><html><body><pre class="r"><span class="no">df_samples_subset</span> <span class="kw">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="kw">pSTAT3_minus_pSTAT1</span> <span class="kw">=</span> <span class="no">pSTAT3</span>-<span class="no">pSTAT1</span>)
<span class="no">df_samples_subset</span> <span class="kw">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="kw">pSTAT5_minus_pSTAT1</span> <span class="kw">=</span> <span class="no">pSTAT5</span>-<span class="no">pSTAT1</span>)
<span class="no">protein_names_diff</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
  <span class="st">"pSTAT3_minus_pSTAT1"</span>,<span class="st">"pSTAT5_minus_pSTAT1"</span>,
  <span class="no">protein_names</span>[!<span class="no">protein_names</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"pSTAT3"</span>,<span class="st">"pSTAT5"</span>)]
)
<span class="no">glmm_fit</span> <span class="kw">=</span> <span class="kw pkg">CytoGLMM</span><span class="kw ns">::</span><span class="fu"><a href="../reference/cytoglmm.html">cytoglmm</a></span>(<span class="no">df_samples_subset</span>,
                              <span class="kw">protein_names</span> <span class="kw">=</span> <span class="no">protein_names_diff</span>,
                              <span class="kw">condition</span> <span class="kw">=</span> <span class="st">"term"</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="st">"donor"</span>)</pre></body></html></div>
<pre><code>## 2020-12-11 22:58:35 INFO:mbest.mhglm:Creating design matrix
## 2020-12-11 22:58:35 INFO:mbest.mhglm:Grouping factor and random effect design matrix
## 2020-12-11 22:58:35 INFO:mbest.mhglm:Setting weights
## 2020-12-11 22:58:35 INFO:mbest.mhglm:Setting offset
## 2020-12-11 22:58:35 INFO:mbest.mhglm:Fitting model
## 2020-12-11 22:58:35 INFO:mbest.mhglm.fit:Fitting models in parallel
## 2020-12-11 22:58:37 INFO:mbest.mhglm.fit:Computing mean and covariance estimates
## 2020-12-11 22:58:37 INFO:mbest.mhglm.fit:Estimating moments
## 2020-12-11 22:58:37 INFO:mbest.mhglm.fit:Computing mean estimate
## 2020-12-11 22:58:37 INFO:mbest.mhglm.fit:Computing covariance estimate
## 2020-12-11 22:58:37 INFO:mbest.mhglm.fit:Refining mean and covariance estimates
## 2020-12-11 22:58:37 INFO:mbest.mhglm.fit:Estimating moments
## 2020-12-11 22:58:37 INFO:mbest.mhglm.fit:Computing mean estimate
## 2020-12-11 22:58:37 INFO:mbest.mhglm.fit:Computing covariance estimate</code></pre>
<div class="sourceCode" id="cb72"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">glmm_fit</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/glmm_fit_differences-1.png" width="700"></p>
<div class="sourceCode" id="cb73"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">glmm_fit</span>) <span class="kw">%&gt;%</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">pvalues_adj</span> <span class="kw">&lt;</span> <span class="fl">0.05</span>)</pre></body></html></div>
<pre><code>## # A tibble: 3 x 3
##   protein_name        pvalues_unadj pvalues_adj
##   &lt;chr&gt;                       &lt;dbl&gt;       &lt;dbl&gt;
## 1 pSTAT3_minus_pSTAT1      6.18e-21    6.18e-20
## 2 pSTAT5_minus_pSTAT1      7.47e- 9    3.74e- 8
## 3 pSTAT1                   2.19e- 4    7.31e- 4</code></pre>
<p>Add interactions between pSTAT1, pSTAT3, and pSTAT5.</p>
<div class="sourceCode" id="cb75"><html><body><pre class="r"><span class="no">df_samples_subset</span> <span class="kw">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="kw">pSTAT_I15</span> <span class="kw">=</span> <span class="no">pSTAT1</span>*<span class="no">pSTAT5</span>)
<span class="no">df_samples_subset</span> <span class="kw">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="kw">pSTAT_I35</span> <span class="kw">=</span> <span class="no">pSTAT3</span>*<span class="no">pSTAT5</span>)
<span class="no">df_samples_subset</span> <span class="kw">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="kw">pSTAT_I13</span> <span class="kw">=</span> <span class="no">pSTAT1</span>*<span class="no">pSTAT3</span>)
<span class="no">df_samples_subset</span> <span class="kw">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="kw">pSTAT_I135</span> <span class="kw">=</span> <span class="no">pSTAT1</span>*<span class="no">pSTAT3</span>*<span class="no">pSTAT5</span>)
<span class="no">protein_names_interactions</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">protein_names</span>,<span class="st">"pSTAT_I15"</span>,<span class="st">"pSTAT_I35"</span>,
                               <span class="st">"pSTAT_I13"</span>,<span class="st">"pSTAT_I135"</span>)
<span class="no">glmm_fit</span> <span class="kw">=</span> <span class="kw pkg">CytoGLMM</span><span class="kw ns">::</span><span class="fu"><a href="../reference/cytoglmm.html">cytoglmm</a></span>(<span class="no">df_samples_subset</span>,
                              <span class="kw">protein_names</span> <span class="kw">=</span> <span class="no">protein_names_interactions</span>,
                              <span class="kw">condition</span> <span class="kw">=</span> <span class="st">"term"</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="st">"donor"</span>)</pre></body></html></div>
<pre><code>## 2020-12-11 22:58:38 INFO:mbest.mhglm:Creating design matrix
## 2020-12-11 22:58:38 INFO:mbest.mhglm:Grouping factor and random effect design matrix
## 2020-12-11 22:58:38 INFO:mbest.mhglm:Setting weights
## 2020-12-11 22:58:38 INFO:mbest.mhglm:Setting offset
## 2020-12-11 22:58:38 INFO:mbest.mhglm:Fitting model
## 2020-12-11 22:58:38 INFO:mbest.mhglm.fit:Fitting models in parallel
## 2020-12-11 22:58:39 INFO:mbest.mhglm.fit:Computing mean and covariance estimates
## 2020-12-11 22:58:39 INFO:mbest.mhglm.fit:Estimating moments
## 2020-12-11 22:58:39 INFO:mbest.mhglm.fit:Computing mean estimate
## 2020-12-11 22:58:39 INFO:mbest.mhglm.fit:Computing covariance estimate
## 2020-12-11 22:58:39 INFO:mbest.mhglm.fit:Refining mean and covariance estimates
## 2020-12-11 22:58:39 INFO:mbest.mhglm.fit:Estimating moments
## 2020-12-11 22:58:39 INFO:mbest.mhglm.fit:Computing mean estimate
## 2020-12-11 22:58:39 INFO:mbest.mhglm.fit:Computing covariance estimate</code></pre>
<div class="sourceCode" id="cb77"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">glmm_fit</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/glmm_fit_interaction-1.png" width="700"></p>
<div class="sourceCode" id="cb78"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">glmm_fit</span>) <span class="kw">%&gt;%</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">pvalues_adj</span> <span class="kw">&lt;</span> <span class="fl">0.05</span>)</pre></body></html></div>
<pre><code>## # A tibble: 6 x 3
##   protein_name pvalues_unadj pvalues_adj
##   &lt;chr&gt;                &lt;dbl&gt;       &lt;dbl&gt;
## 1 pSTAT3            2.52e-13    3.53e-12
## 2 pSTAT1            3.47e-11    2.43e-10
## 3 pSTAT_I13         1.82e- 4    8.48e- 4
## 4 pERK1_2           1.55e- 2    4.82e- 2
## 5 pNFkB             1.90e- 2    4.82e- 2
## 6 pSTAT5            2.06e- 2    4.82e- 2</code></pre>
</div>
<div id="generalized-linear-model-with-bootstrap" class="section level2">
<h2 class="hasAnchor">
<a href="#generalized-linear-model-with-bootstrap" class="anchor"></a>Generalized Linear Model with Bootstrap</h2>
<p>Instead of modeling the donor effect, we can use bootstrap resampling. In our experience, this type of regression gives also good results when samples are not matched between conditions on the same donor.</p>
<div class="sourceCode" id="cb80"><html><body><pre class="r"><span class="no">glm_fit</span> <span class="kw">=</span> <span class="kw pkg">CytoGLMM</span><span class="kw ns">::</span><span class="fu"><a href="../reference/cytoglm.html">cytoglm</a></span>(<span class="no">df_samples_subset</span>,
                            <span class="kw">num_boot</span> <span class="kw">=</span> <span class="fl">1000</span>,
                            <span class="kw">protein_names</span> <span class="kw">=</span> <span class="no">protein_names</span>,
                            <span class="kw">condition</span> <span class="kw">=</span> <span class="st">"term"</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="st">"donor"</span>)
<span class="no">glm_fit</span></pre></body></html></div>
<pre><code>## 
## #######################
## ## paired analysis ####
## #######################
## 
## number of bootstrap samples: 1000 
## 
## number of cells per group and condition:         
##           1st trimester 3rd trimester
##   PTLG001          3474          3125
##   PTLG002          5438          6120
##   PTLG003          8087          5035
##   PTLG004          4991          6501
##   PTLG005          6105          5074
##   PTLG007          5766          5302
##   PTLG008         13395          7953
##   PTLG009          5177          3764
##   PTLG010          4273          4908
##   PTLG012          6624          5643
##   PTLG018          4083          7620
##   PTLG019          6671          4542
##   PTLG020          3412          3230
##   PTLG022          8222          5709
##   PTLG024          4100          2380
##   PTLG029          7211          4937
## 
## proteins included in the analysis:
##  pCREB pSTAT5 pP38 pSTAT1 pSTAT3 prpS6 pMAPKAPK IkB pNFkB pERK1_2 
## 
## condition compared: term 
## grouping variable: donor</code></pre>
<div class="sourceCode" id="cb82"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">glm_fit</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/glm_fit-1.png" width="700"></p>
<div class="sourceCode" id="cb83"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">glm_fit</span>) <span class="kw">%&gt;%</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">pvalues_adj</span> <span class="kw">&lt;</span> <span class="fl">0.05</span>)</pre></body></html></div>
<pre><code>## # A tibble: 3 x 3
##   protein_name pvalues_unadj pvalues_adj
##   &lt;chr&gt;                &lt;dbl&gt;       &lt;dbl&gt;
## 1 pSTAT1               0.002     0.00667
## 2 pSTAT3               0.002     0.00667
## 3 pSTAT5               0.002     0.00667</code></pre>
</div>
<div id="mixture-of-regressions" class="section level2">
<h2 class="hasAnchor">
<a href="#mixture-of-regressions" class="anchor"></a>Mixture of Regressions</h2>
<p>Fit a mixture of regression model to identity clusters of donors or outliers. This function is a wrapper around the package <code>flexmix</code> <span class="citation">(Grün and Leisch 2007)</span>.</p>
<div class="sourceCode" id="cb85"><html><body><pre class="r"><span class="no">num_donors</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nlevels.html">nlevels</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="no">df_samples_subset</span>$<span class="no">donor</span>))
<span class="no">mix_fit</span> <span class="kw">=</span> <span class="kw pkg">CytoGLMM</span><span class="kw ns">::</span><span class="fu"><a href="../reference/cytoflexmix.html">cytoflexmix</a></span>(<span class="no">df_samples_subset</span>,
                                <span class="kw">protein_names</span> <span class="kw">=</span> <span class="no">protein_names</span>,
                                <span class="kw">condition</span> <span class="kw">=</span> <span class="st">"term"</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="st">"donor"</span>,
                                <span class="kw">ks</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="no">num_donors</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(<span class="no">mix_fit</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/mix_fit-1.png" width="700"></p>
<p>The plotting function automatically uses the BIC criterion to select the number of clusters. In this case, it picks 10 clusters.</p>
<div class="sourceCode" id="cb86"><html><body><pre class="r"><span class="fu"><a href="../reference/plot_model_selection.html">plot_model_selection</a></span>(<span class="no">mix_fit</span>)</pre></body></html></div>
<p><img src="CytoGLMM_files/figure-html/bic_model_selection-1.png" width="700"></p>
</div>
</div>
<div id="summarizedexperiment" class="section level1">
<h1 class="hasAnchor">
<a href="#summarizedexperiment" class="anchor"></a>SummarizedExperiment</h1>
<p>We create a <code>SummarizedExperiment</code> object containing marker, sample table, and untransformed protein counts. This way we can store all the information of this experiment in one file and load it again in subsequent analyses.</p>
<div class="sourceCode" id="cb87"><html><body><pre class="r"><span class="no">markers</span> <span class="kw">%&lt;&gt;%</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="no">type</span> <span class="kw">!=</span> <span class="st">"none"</span>)
<span class="no">d_combined</span> <span class="kw">=</span> <span class="no">df_samples</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">markers</span>$<span class="no">protein_name</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span>(<span class="kw">.funs</span> <span class="kw">=</span> <span class="no">inv_func</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_all</a></span>(<span class="kw">.funs</span> <span class="kw">=</span> <span class="no">round</span>) <span class="kw">%&gt;%</span>
  <span class="no">as.matrix</span>
<span class="no">row_data</span> <span class="kw">=</span> <span class="no">df_samples</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">sample_info_names</span>) <span class="kw">%&gt;%</span>
  <span class="no">as.data.frame</span>
<span class="no">col_data</span> <span class="kw">=</span> <span class="no">markers</span> <span class="kw">%&gt;%</span> <span class="no">as.data.frame</span>
<span class="no">se_aghaeepour2017immune</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/RangedSummarizedExperiment-class.html">SummarizedExperiment</a></span>(
  <span class="kw">assays</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">exprs</span> <span class="kw">=</span> <span class="no">d_combined</span>),
  <span class="kw">colData</span> <span class="kw">=</span> <span class="no">col_data</span>,
  <span class="kw">rowData</span> <span class="kw">=</span> <span class="no">row_data</span>
)
<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span>(<span class="no">se_aghaeepour2017immune</span>, <span class="kw">file</span> <span class="kw">=</span> <span class="st">"se_aghaeepour2017immune.Rdata"</span>)</pre></body></html></div>
</div>
<div id="session-info" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#session-info" class="anchor"></a>Session Info</h1>
<div class="sourceCode" id="cb88"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span>()</pre></body></html></div>
<pre><code>## R version 3.6.2 (2019-12-12)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS Catalina 10.15.7
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
##  [1] grid      stats4    parallel  stats     graphics  grDevices utils    
##  [8] datasets  methods   base     
## 
## other attached packages:
##  [1] Rgraphviz_2.30.0            graph_1.64.0               
##  [3] lmerTest_3.1-1              lme4_1.1-23                
##  [5] Matrix_1.2-18               SummarizedExperiment_1.16.1
##  [7] DelayedArray_0.12.2         BiocParallel_1.20.1        
##  [9] matrixStats_0.56.0          Biobase_2.46.0             
## [11] GenomicRanges_1.38.0        GenomeInfoDb_1.22.0        
## [13] IRanges_2.20.2              S4Vectors_0.24.3           
## [15] BiocGenerics_0.32.0         ggcorrplot_0.1.3           
## [17] RColorBrewer_1.1-2          scales_1.1.1               
## [19] ggcyto_1.14.1               flowWorkspace_3.34.1       
## [21] ncdfFlow_2.32.0             BH_1.72.0-3                
## [23] RcppArmadillo_0.9.880.1.0   openCyto_1.24.0            
## [25] flowCore_1.52.1             FlowRepositoryR_1.18.0     
## [27] magrittr_1.5                forcats_0.5.0              
## [29] stringr_1.4.0               dplyr_1.0.0                
## [31] purrr_0.3.4                 readr_1.3.1                
## [33] tidyr_1.1.0                 tibble_3.0.1               
## [35] ggplot2_3.3.2               tidyverse_1.3.0            
## [37] CytoGLMM_0.1.0              Rcpp_1.0.4.6               
## [39] BiocStyle_2.14.4           
## 
## loaded via a namespace (and not attached):
##   [1] utf8_1.1.4             R.utils_2.9.2          ks_1.11.7             
##   [4] tidyselect_1.1.0       pROC_1.16.1            munsell_0.5.0         
##   [7] codetools_0.2-16       statmod_1.4.34         withr_2.2.0           
##  [10] colorspace_1.4-1       flowViz_1.50.0         knitr_1.28            
##  [13] rstudioapi_0.11        flowClust_3.24.0       robustbase_0.93-5     
##  [16] ggsignif_0.6.0         labeling_0.3           GenomeInfoDbData_1.2.2
##  [19] mnormt_1.5-6           farver_2.0.3           pheatmap_1.0.12       
##  [22] rprojroot_1.3-2        vctrs_0.3.0            generics_0.0.2        
##  [25] ipred_0.9-9            xfun_0.12              R6_2.4.1              
##  [28] doParallel_1.0.15      clue_0.3-57            isoband_0.2.1         
##  [31] flexmix_2.3-15         bitops_1.0-6           assertthat_0.2.1      
##  [34] nnet_7.3-12            gtable_0.3.0           sandwich_2.5-1        
##  [37] timeDate_3043.102      rlang_0.4.6            mbest_0.6             
##  [40] splines_3.6.2          ModelMetrics_1.2.2.1   hexbin_1.28.1         
##  [43] broom_0.5.4            BiocManager_1.30.10    yaml_2.2.1            
##  [46] reshape2_1.4.4         abind_1.4-5            modelr_0.1.6          
##  [49] backports_1.1.7        IDPmisc_1.1.20         RBGL_1.62.1           
##  [52] caret_6.0-85           tools_3.6.2            lava_1.6.6            
##  [55] bookdown_0.17          logging_0.10-108       ellipsis_0.3.1        
##  [58] plyr_1.8.6             zlibbioc_1.32.0        RCurl_1.98-1.1        
##  [61] ggpubr_0.2.5           rpart_4.1-15           cowplot_1.0.0         
##  [64] zoo_1.8-7              haven_2.3.1            ggrepel_0.8.2         
##  [67] cluster_2.1.0          fs_1.4.1               factoextra_1.0.6      
##  [70] fda_2.4.8.1            data.table_1.12.8      reprex_0.3.0          
##  [73] mvtnorm_1.0-12         hms_0.5.3              evaluate_0.14         
##  [76] XML_3.99-0.3           jpeg_0.1-8.1           mclust_5.4.5          
##  [79] readxl_1.3.1           gridExtra_2.3          compiler_3.6.2        
##  [82] ellipse_0.4.1          flowStats_3.44.0       KernSmooth_2.23-16    
##  [85] crayon_1.3.4           minqa_1.2.4            R.oo_1.23.0           
##  [88] htmltools_0.4.0        corpcor_1.6.9          pcaPP_1.9-73          
##  [91] rrcov_1.5-2            speedglm_0.3-2         RcppParallel_5.0.1    
##  [94] lubridate_1.7.4        DBI_1.1.0              dbplyr_1.4.2          
##  [97] MASS_7.3-51.5          boot_1.3-24            cli_2.0.2             
## [100] R.methodsS3_1.8.0      gower_0.2.1            pkgconfig_2.0.3       
## [103] bigmemory.sri_0.1.3    pkgdown_1.5.1          numDeriv_2016.8-1.1   
## [106] recipes_0.1.9          xml2_1.3.1             foreach_1.4.8         
## [109] XVector_0.26.0         prodlim_2019.11.13     rvest_0.3.5           
## [112] digest_0.6.25          strucchange_1.5-2      rmarkdown_2.1         
## [115] cellranger_1.1.0       gtools_3.8.1           modeltools_0.2-22     
## [118] nloptr_1.2.2.1         lifecycle_0.2.0        nlme_3.1-144          
## [121] jsonlite_1.6.1         bigmemory_4.5.36       desc_1.2.0            
## [124] fansi_0.4.1            pillar_1.4.4           lattice_0.20-40       
## [127] httr_1.4.1             DEoptimR_1.0-8         survival_3.1-8        
## [130] glue_1.4.1             png_0.1-7              iterators_1.0.12      
## [133] class_7.3-15           stringi_1.4.6          latticeExtra_0.6-29   
## [136] memoise_1.1.0</code></pre>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-aghaeepour2017immune">
<p>Aghaeepour, Nima, Edward A. Ganio, David Mcilwain, Amy S. Tsai, Martha Tingle, Van GassenSofie, Dyani K. Gaudilliere, et al. 2017. “An Immune Clock of Human Pregnancy.” <em>Science Immunology</em> 2 (15): eaan2946. <a href="https://doi.org/10.1126/sciimmunol.aan2946">https://doi.org/10.1126/sciimmunol.aan2946</a>.</p>
</div>
<div id="ref-grun2007fitting">
<p>Grün, Bettina, and Friedrich Leisch. 2007. “Fitting Finite Mixtures of Generalized Linear Regressions in R.” <em>Computational Statistics &amp; Data Analysis</em> 51 (11): 5247–52.</p>
</div>
<div id="ref-Nowicka2017cytof">
<p>Nowicka, M, C Krieg, LM Weber, FJ Hartmann, S Guglietta, B Becher, MP Levesque, and MD Robinson. 2017. “CyTOF Workflow: Differential Discovery in High-Throughput High-Dimensional Cytometry Datasets.” <em>F1000Research</em> 6 (748). <a href="https://doi.org/10.12688/f1000research.11622.2">https://doi.org/10.12688/f1000research.11622.2</a>.</p>
</div>
<div id="ref-perry2017fast">
<p>Perry, Patrick O. 2017. “Fast Moment-Based Estimation for Hierarchical Models.” <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em> 79 (1): 267–91.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Christof Seiler.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
