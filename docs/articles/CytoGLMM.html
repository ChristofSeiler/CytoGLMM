<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CytoGLMM Workflow • CytoGLMM</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="CytoGLMM Workflow">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CytoGLMM</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/CytoGLMM.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>CytoGLMM Workflow</h1>
                        <h4 class="author">Christof Seiler</h4>
            <address class="author_afil">
      Department of Statistics, Stanford University<br><div class="hidden name"><code>CytoGLMM.Rmd</code></div>

    </address>
</div>

    
    
<div id="goal" class="section level1">
<h1 class="hasAnchor">
<a href="#goal" class="anchor"></a>Goal</h1>
<p>This is a step-by-step guide for a complete analysis of mass cytometry data.</p>
</div>
<div id="prerequisites" class="section level1">
<h1 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h1>
<p>Install <a href="https://www.r-project.org/">R</a> and <a href="https://www.rstudio.com/">RStudio</a>. Open this <code>Rmd</code> file in RStudio. Then run the following code to install all required packages.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1">pkgs_needed =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"devtools"</span>,<span class="st">"tidyverse"</span>,<span class="st">"magrittr"</span>,<span class="st">"FlowRepositoryR"</span>,</a>
<a class="sourceLine" id="cb1-2" title="2">                <span class="st">"flowCore"</span>,<span class="st">"openCyto"</span>,<span class="st">"scales"</span>,<span class="st">"parallel"</span>,</a>
<a class="sourceLine" id="cb1-3" title="3">                <span class="st">"RColorBrewer"</span>,<span class="st">"ggcorrplot"</span>,<span class="st">"SummarizedExperiment"</span>,</a>
<a class="sourceLine" id="cb1-4" title="4">                <span class="st">"lme4"</span>,<span class="st">"lmerTest"</span>)</a>
<a class="sourceLine" id="cb1-5" title="5">letsinstall =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sets">setdiff</a></span>(pkgs_needed, <span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/installed.packages">installed.packages</a></span>())</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(letsinstall) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb1-7" title="7">  BiocManager<span class="op">::</span><span class="kw">install</span>(letsinstall)</a>
<a class="sourceLine" id="cb1-8" title="8">}</a>
<a class="sourceLine" id="cb1-9" title="9"><span class="co"># package is still private</span></a>
<a class="sourceLine" id="cb1-10" title="10">devtools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/devtools/topics/reexports">install_github</a></span>(<span class="st">"ChristofSeiler/CytoGLMM"</span>)</a>
<a class="sourceLine" id="cb1-11" title="11"><span class="co"># Bioconductor version breaks when updating to ggplot2 v3.0</span></a>
<a class="sourceLine" id="cb1-12" title="12">devtools<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/devtools/topics/reexports">install_github</a></span>(<span class="st">"RGLab/ggcyto"</span>, <span class="dt">ref=</span><span class="st">"trunk"</span>)</a></code></pre></div>
<p>Load packages.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"CytoGLMM"</span>)</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"tidyverse"</span>)</a>
<a class="sourceLine" id="cb2-3" title="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"magrittr"</span>)</a>
<a class="sourceLine" id="cb2-4" title="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"FlowRepositoryR"</span>)</a>
<a class="sourceLine" id="cb2-5" title="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"flowCore"</span>)</a>
<a class="sourceLine" id="cb2-6" title="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"openCyto"</span>)</a>
<a class="sourceLine" id="cb2-7" title="7"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"ggcyto"</span>)</a>
<a class="sourceLine" id="cb2-8" title="8"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"scales"</span>)</a>
<a class="sourceLine" id="cb2-9" title="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"parallel"</span>)</a>
<a class="sourceLine" id="cb2-10" title="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"RColorBrewer"</span>)</a>
<a class="sourceLine" id="cb2-11" title="11"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"ggcorrplot"</span>)</a>
<a class="sourceLine" id="cb2-12" title="12"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"SummarizedExperiment"</span>)</a>
<a class="sourceLine" id="cb2-13" title="13"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"lme4"</span>)</a>
<a class="sourceLine" id="cb2-14" title="14"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(<span class="st">"lmerTest"</span>)</a></code></pre></div>
<p>Set plotting style and assign computational resources.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="kw">theme_set</span>(<span class="kw">theme_light</span>())</a>
<a class="sourceLine" id="cb3-2" title="2">ncores =<span class="st"> </span>parallel<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/parallel/topics/detectCores">detectCores</a></span>()</a></code></pre></div>
</div>
<div id="download-and-prepare-data" class="section level1">
<h1 class="hasAnchor">
<a href="#download-and-prepare-data" class="anchor"></a>Download and Prepare Data</h1>
<div id="fcs-files" class="section level2">
<h2 class="hasAnchor">
<a href="#fcs-files" class="anchor"></a>FCS Files</h2>
<p>Reanalysis of mass cytometry data from <span class="citation">Aghaeepour et al. (2017)</span>. We use the package <code>FlowRepositoryR</code> to download <code>fcs</code> files from <a href="http://flowrepository.org/id/FR-FCM-ZY3Q">FlowRepository</a>. We download mass cytometry data measured on whole blood samples collected from 16 women during pregnancy stimulated with IFNa at first and third trimester.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1">repo =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/FlowRepositoryR/topics/flowRep.get">flowRep.get</a></span>(<span class="st">"FR-FCM-ZY3Q"</span>)</a>
<a class="sourceLine" id="cb4-2" title="2">data =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/FlowRepositoryR/topics/download-methods">download</a></span>(repo, <span class="dt">only.files =</span> <span class="st">".*_2_IFNa.*fcs"</span>)</a>
<a class="sourceLine" id="cb4-3" title="3">data =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/FlowRepositoryR/topics/download-methods">download</a></span>(repo, <span class="dt">only.files =</span> <span class="st">".*_BL_IFNa.*fcs"</span>)</a></code></pre></div>
</div>
<div id="sample-table" class="section level2">
<h2 class="hasAnchor">
<a href="#sample-table" class="anchor"></a>Sample Table</h2>
<p>The previous commands downloaded <code>fcs</code> files to the <code>FR-FCM-ZY3Q</code> folder. Now, we prepare the sample table by parsing the <code>fcs</code> filenames. For some studies, it might be easier to prepare a <code>sample_table.csv</code> textfile and load it using the <code>readr</code> package.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1">fcs_files =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list.files">list.files</a></span>(<span class="dt">path =</span> <span class="st">"FR-FCM-ZY3Q/"</span>, <span class="dt">pattern =</span> <span class="st">"fcs"</span>)</a>
<a class="sourceLine" id="cb5-2" title="2">map_time =<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb5-3" title="3">  <span class="cf">if</span> (<span class="kw">str_detect</span>(x, <span class="st">"_2_"</span>)) <span class="st">"3rd trimester"</span></a>
<a class="sourceLine" id="cb5-4" title="4">  <span class="cf">else</span> <span class="cf">if</span> (<span class="kw">str_detect</span>(x, <span class="st">"_BL_"</span>)) <span class="st">"1st trimester"</span></a>
<a class="sourceLine" id="cb5-5" title="5">  <span class="cf">else</span> <span class="ot">NA</span></a>
<a class="sourceLine" id="cb5-6" title="6">}</a>
<a class="sourceLine" id="cb5-7" title="7">sample_table =<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb5-8" title="8">  <span class="dt">donor =</span> <span class="kw">str_extract</span>(fcs_files, <span class="st">"PTLG[0-9]{3}"</span>),</a>
<a class="sourceLine" id="cb5-9" title="9">  <span class="dt">term =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(fcs_files, map_time) <span class="op">%&gt;%</span><span class="st"> </span>as.factor,</a>
<a class="sourceLine" id="cb5-10" title="10">  <span class="dt">file_name =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"FR-FCM-ZY3Q/"</span>,fcs_files)</a>
<a class="sourceLine" id="cb5-11" title="11">)</a>
<a class="sourceLine" id="cb5-12" title="12">sample_table</a></code></pre></div>
<pre><code>## # A tibble: 32 x 3
##    donor   term          file_name                                
##    &lt;chr&gt;   &lt;fct&gt;         &lt;chr&gt;                                    
##  1 PTLG001 3rd trimester FR-FCM-ZY3Q/Gates_PTLG001_2_IFNa_100.fcs 
##  2 PTLG001 1st trimester FR-FCM-ZY3Q/Gates_PTLG001_BL_IFNa_100.fcs
##  3 PTLG002 3rd trimester FR-FCM-ZY3Q/Gates_PTLG002_2_IFNa_100.fcs 
##  4 PTLG002 1st trimester FR-FCM-ZY3Q/Gates_PTLG002_BL_IFNa_100.fcs
##  5 PTLG003 3rd trimester FR-FCM-ZY3Q/Gates_PTLG003_2_IFNa_100.fcs 
##  6 PTLG003 1st trimester FR-FCM-ZY3Q/Gates_PTLG003_BL_IFNa_100.fcs
##  7 PTLG004 3rd trimester FR-FCM-ZY3Q/Gates_PTLG004_2_IFNa_100.fcs 
##  8 PTLG004 1st trimester FR-FCM-ZY3Q/Gates_PTLG004_BL_IFNa_100.fcs
##  9 PTLG005 3rd trimester FR-FCM-ZY3Q/Gates_PTLG005_2_IFNa_100.fcs 
## 10 PTLG005 1st trimester FR-FCM-ZY3Q/Gates_PTLG005_BL_IFNa_100.fcs
## # ... with 22 more rows</code></pre>
</div>
<div id="marker-table" class="section level2">
<h2 class="hasAnchor">
<a href="#marker-table" class="anchor"></a>Marker Table</h2>
<p>Load marker isotopes and protein names. Make sure that marker names don’t have <code>-</code> or start with a number. This is important to be compatible with the formula syntax of <code>R</code>.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">markers =<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">"markers.csv"</span>)</a>
<a class="sourceLine" id="cb7-2" title="2">markers<span class="op">$</span>protein_name <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">str_replace_all</span>(<span class="st">"-"</span>,<span class="st">"_"</span>)</a>
<a class="sourceLine" id="cb7-3" title="3">markers<span class="op">$</span>protein_name <span class="op">%&lt;&gt;%</span><span class="st"> </span>make.names</a>
<a class="sourceLine" id="cb7-4" title="4">markers</a></code></pre></div>
<pre><code>## # A tibble: 35 x 3
##    isotope      protein_name type     
##    &lt;chr&gt;        &lt;chr&gt;        &lt;chr&gt;    
##  1 Event_length Event_length none     
##  2 In113Di      CD235ab_CD61 phenotype
##  3 In115Di      CD45         phenotype
##  4 La139Di      CD66         phenotype
##  5 Pr141Di      CD7          phenotype
##  6 Nd142Di      CD19         phenotype
##  7 Nd143Di      CD45RA       phenotype
##  8 Nd144Di      CD11b        phenotype
##  9 Nd145Di      CD4          phenotype
## 10 Nd146Di      CD8a         phenotype
## # ... with 25 more rows</code></pre>
<p>Check if bead normalized. This only works if the bead normalizer added an additional column <code>beadDist</code> to the <code>fcs</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/flowCore/topics/read.FCS">read.FCS</a></span>(sample_table<span class="op">$</span>file_name[<span class="dv">1</span>])) <span class="op">==</span><span class="st"> "beadDist"</span>)<span class="op">==</span><span class="dv">1</span>,</a>
<a class="sourceLine" id="cb9-2" title="2">       <span class="dt">yes =</span> <span class="st">"bead normalized"</span>,</a>
<a class="sourceLine" id="cb9-3" title="3">       <span class="dt">no =</span> <span class="st">"not bead normalized"</span>)</a></code></pre></div>
<pre><code>## uneven number of tokens: 571
## The last keyword is dropped.
## uneven number of tokens: 571
## The last keyword is dropped.</code></pre>
<pre><code>## [1] "bead normalized"</code></pre>
</div>
</div>
<div id="gating" class="section level1">
<h1 class="hasAnchor">
<a href="#gating" class="anchor"></a>Gating</h1>
<p>Gate with <a href="https://bioconductor.org/packages/release/bioc/html/openCyto.html">openCyto</a> according to supplementary material (Fig. S1) from <span class="citation">Aghaeepour et al. (2017)</span>.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="co"># load data</span></a>
<a class="sourceLine" id="cb12-2" title="2">ncfs =<span class="st"> </span><span class="kw">read.ncdfFlowSet</span>(sample_table<span class="op">$</span>file_name, <span class="dt">mc.cores =</span> ncores)</a></code></pre></div>
<pre><code>## uneven number of tokens: 571
## The last keyword is dropped.</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">gs =<span class="st"> </span><span class="kw">GatingSet</span>(ncfs)</a>
<a class="sourceLine" id="cb14-2" title="2"><span class="kw">pData</span>(gs) =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">cbind</a></span>(<span class="kw">pData</span>(gs),sample_table)</a>
<a class="sourceLine" id="cb14-3" title="3">trans_func =<span class="st"> </span><span class="cf">function</span>(x) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Hyperbolic">asinh</a></span>(x<span class="op">/</span><span class="dv">5</span>)</a>
<a class="sourceLine" id="cb14-4" title="4">inv_func =<span class="st"> </span><span class="cf">function</span>(x) <span class="dv">5</span><span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Hyperbolic">sinh</a></span>(x)</a>
<a class="sourceLine" id="cb14-5" title="5">trans_obj =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/scales/topics/trans_new">trans_new</a></span>(<span class="st">"asinh_cytof"</span>, trans_func, inv_func)</a>
<a class="sourceLine" id="cb14-6" title="6">translist =<span class="st"> </span><span class="kw">transformerList</span>(markers<span class="op">$</span>isotope[<span class="op">-</span><span class="dv">1</span>], trans_obj)</a>
<a class="sourceLine" id="cb14-7" title="7">gs =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/flowCore/topics/transform-class">transform</a></span>(gs, translist)</a>
<a class="sourceLine" id="cb14-8" title="8"><span class="co"># apply gating template</span></a>
<a class="sourceLine" id="cb14-9" title="9">gt_aghaeepour =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/openCyto/topics/gatingTemplate-class">gatingTemplate</a></span>(<span class="st">"gating_template.csv"</span>)</a>
<a class="sourceLine" id="cb14-10" title="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(gt_aghaeepour)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/opencyto-1.png" width="700"></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/openCyto/topics/gating-methods">gating</a></span>(gt_aghaeepour, gs, <span class="dt">mc.cores =</span> ncores, <span class="dt">parallel_type =</span> <span class="st">"multicore"</span>)</a>
<a class="sourceLine" id="cb15-2" title="2"><span class="co"># rename some subsets</span></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="kw">setNode</span>(gs, <span class="st">"/singlet/leukocyte/mononuclear/CD3+CD19-/CD4+CD8a-/CD45RA+"</span>, </a>
<a class="sourceLine" id="cb15-4" title="4">        <span class="st">"CD4+Tnaive"</span>) <span class="op">%&gt;%</span><span class="st"> </span>invisible</a>
<a class="sourceLine" id="cb15-5" title="5"><span class="kw">setNode</span>(gs, <span class="st">"/singlet/leukocyte/mononuclear/CD3+CD19-/CD4+CD8a-/CD45RA-"</span>, </a>
<a class="sourceLine" id="cb15-6" title="6">        <span class="st">"CD4+Tmem"</span>) <span class="op">%&gt;%</span><span class="st"> </span>invisible</a>
<a class="sourceLine" id="cb15-7" title="7"><span class="kw">setNode</span>(gs, <span class="st">"/singlet/leukocyte/mononuclear/CD3+CD19-/CD4-CD8a+/CD45RA+"</span>, </a>
<a class="sourceLine" id="cb15-8" title="8">        <span class="st">"CD8+Tnaive"</span>) <span class="op">%&gt;%</span><span class="st"> </span>invisible</a>
<a class="sourceLine" id="cb15-9" title="9"><span class="kw">setNode</span>(gs, <span class="st">"/singlet/leukocyte/mononuclear/CD3+CD19-/CD4-CD8a+/CD45RA-"</span>, </a>
<a class="sourceLine" id="cb15-10" title="10">        <span class="st">"CD8+Tmem"</span>) <span class="op">%&gt;%</span><span class="st"> </span>invisible</a>
<a class="sourceLine" id="cb15-11" title="11"><span class="kw">setNode</span>(gs, <span class="st">"CD3-CD19+"</span>, <span class="st">"B"</span>) <span class="op">%&gt;%</span><span class="st"> </span>invisible</a>
<a class="sourceLine" id="cb15-12" title="12"><span class="kw">setNode</span>(gs, <span class="st">"CD3+CD19-"</span>, <span class="st">"T"</span>) <span class="op">%&gt;%</span><span class="st"> </span>invisible</a>
<a class="sourceLine" id="cb15-13" title="13"><span class="kw">setNode</span>(gs, <span class="st">"CD4+CD8a-"</span>, <span class="st">"CD4+T"</span>) <span class="op">%&gt;%</span><span class="st"> </span>invisible</a>
<a class="sourceLine" id="cb15-14" title="14"><span class="kw">setNode</span>(gs, <span class="st">"CD4-CD8a+"</span>, <span class="st">"CD8+T"</span>) <span class="op">%&gt;%</span><span class="st"> </span>invisible</a>
<a class="sourceLine" id="cb15-15" title="15"><span class="kw">setNode</span>(gs, <span class="st">"CD7+"</span>, <span class="st">"NK"</span>) <span class="op">%&gt;%</span><span class="st"> </span>invisible</a>
<a class="sourceLine" id="cb15-16" title="16"><span class="kw">setNode</span>(gs, <span class="st">"CD14+CD16-"</span>, <span class="st">"cMC"</span>) <span class="op">%&gt;%</span><span class="st"> </span>invisible</a>
<a class="sourceLine" id="cb15-17" title="17"><span class="kw">setNode</span>(gs, <span class="st">"CD14-CD16+"</span>, <span class="st">"ncMC"</span>) <span class="op">%&gt;%</span><span class="st"> </span>invisible</a>
<a class="sourceLine" id="cb15-18" title="18"><span class="kw">setNode</span>(gs, <span class="st">"CD14+CD16+"</span>, <span class="st">"intMC"</span>) <span class="op">%&gt;%</span><span class="st"> </span>invisible</a>
<a class="sourceLine" id="cb15-19" title="19"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(gs)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/opencyto-2.png" width="700"></p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="co"># hide nodes</span></a>
<a class="sourceLine" id="cb16-2" title="2">nodes_to_hide =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(</a>
<a class="sourceLine" id="cb16-3" title="3">  <span class="st">"granulocyte"</span>, <span class="st">"CD19+"</span>, <span class="st">"CD3+"</span>, <span class="st">"CD3+CD19+"</span>,</a>
<a class="sourceLine" id="cb16-4" title="4">  <span class="st">"CD8a+"</span>, <span class="st">"CD4+"</span>, <span class="st">"CD16+"</span>, <span class="st">"CD14+"</span>, <span class="st">"CD14-CD16-"</span>,</a>
<a class="sourceLine" id="cb16-5" title="5">  <span class="st">"CD4+CD8a+"</span>, <span class="st">"CD4+Tnaive/CD25+"</span>, <span class="st">"CD4+Tmem/CD25+"</span>, </a>
<a class="sourceLine" id="cb16-6" title="6">  <span class="st">"CD4+Tnaive/FoxP3+"</span>, <span class="st">"CD4+Tmem/FoxP3+"</span></a>
<a class="sourceLine" id="cb16-7" title="7">  )</a>
<a class="sourceLine" id="cb16-8" title="8"><span class="cf">for</span>(this_node <span class="cf">in</span> nodes_to_hide) <span class="kw">setNode</span>(gs, this_node, <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb16-9" title="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(gs)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/opencyto-3.png" width="700"></p>
<p>Visualize gates with <a href="https://bioconductor.org/packages/release/bioc/html/ggcyto.html">ggcyto</a>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">0xdada</span>)</a>
<a class="sourceLine" id="cb17-2" title="2">ids =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(gs), <span class="dt">size =</span> <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb17-3" title="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto">ggcyto</a></span>(gs[ids], <span class="kw">aes</span>(<span class="dt">x =</span> CD66, <span class="dt">y =</span> CD45), <span class="dt">subset =</span> <span class="st">"leukocyte"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto_par_set">ggcyto_par_set</a></span>(<span class="dt">limits =</span> <span class="st">"instrument"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">64</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/geom_gate">geom_gate</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"mononuclear"</span>,<span class="st">"granulocyte"</span>))</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-1.png" width="700"></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto">ggcyto</a></span>(gs[ids], <span class="kw">aes</span>(<span class="dt">x =</span> CD3, <span class="dt">y =</span> CD19), <span class="dt">subset =</span> <span class="st">"mononuclear"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto_par_set">ggcyto_par_set</a></span>(<span class="dt">limits =</span> <span class="st">"instrument"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">64</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/geom_gate">geom_gate</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"B"</span>,<span class="st">"T"</span>,<span class="st">"CD3-CD19-"</span>))</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-2.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto">ggcyto</a></span>(gs[ids], <span class="kw">aes</span>(<span class="dt">x =</span> CD14, <span class="dt">y =</span> CD7), <span class="dt">subset =</span> <span class="st">"CD3-CD19-"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb19-2" title="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto_par_set">ggcyto_par_set</a></span>(<span class="dt">limits =</span> <span class="st">"instrument"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">64</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/geom_gate">geom_gate</a></span>(<span class="st">"NK"</span>)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-3.png" width="700"></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto">ggcyto</a></span>(gs[ids], <span class="kw">aes</span>(<span class="dt">x =</span> CD14, <span class="dt">y =</span> CD16), <span class="dt">subset =</span> <span class="st">"CD7-"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-2" title="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto_par_set">ggcyto_par_set</a></span>(<span class="dt">limits =</span> <span class="st">"instrument"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">64</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/geom_gate">geom_gate</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"cMC"</span>,<span class="st">"ncMC"</span>,<span class="st">"intMC"</span>))</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-4.png" width="700"></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto">ggcyto</a></span>(gs[ids], <span class="kw">aes</span>(<span class="dt">x =</span> CD4, <span class="dt">y =</span> CD8a), <span class="dt">subset =</span> <span class="st">"T"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb21-2" title="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto_par_set">ggcyto_par_set</a></span>(<span class="dt">limits =</span> <span class="st">"instrument"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">64</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/geom_gate">geom_gate</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CD4+T"</span>,<span class="st">"CD8+T"</span>,<span class="st">"CD4-CD8a-"</span>))</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-5.png" width="700"></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto">ggcyto</a></span>(gs[ids], <span class="kw">aes</span>(<span class="dt">x =</span> TCRgd, <span class="dt">y =</span> CD3), <span class="dt">subset =</span> <span class="st">"CD4-CD8a-"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto_par_set">ggcyto_par_set</a></span>(<span class="dt">limits =</span> <span class="st">"instrument"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">64</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/geom_gate">geom_gate</a></span>(<span class="st">"gdT"</span>)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-6.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto">ggcyto</a></span>(gs[ids], <span class="kw">aes</span>(<span class="dt">x =</span> CD4, <span class="dt">y =</span> CD45RA), <span class="dt">subset =</span> <span class="st">"CD4+T"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb23-2" title="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto_par_set">ggcyto_par_set</a></span>(<span class="dt">limits =</span> <span class="st">"instrument"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">64</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb23-3" title="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/geom_gate">geom_gate</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CD4+Tnaive"</span>,<span class="st">"CD4+Tmem"</span>))</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-7.png" width="700"></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto">ggcyto</a></span>(gs[ids], <span class="kw">aes</span>(<span class="dt">x =</span> FoxP3, <span class="dt">y =</span> CD25), <span class="dt">subset =</span> <span class="st">"CD4+Tnaive"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-2" title="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto_par_set">ggcyto_par_set</a></span>(<span class="dt">limits =</span> <span class="st">"instrument"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">64</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-3" title="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/geom_gate">geom_gate</a></span>(<span class="st">"Tregsnaive"</span>)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-8.png" width="700"></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto">ggcyto</a></span>(gs[ids], <span class="kw">aes</span>(<span class="dt">x =</span> FoxP3, <span class="dt">y =</span> CD25), <span class="dt">subset =</span> <span class="st">"CD4+Tmem"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb25-2" title="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto_par_set">ggcyto_par_set</a></span>(<span class="dt">limits =</span> <span class="st">"instrument"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">64</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/geom_gate">geom_gate</a></span>(<span class="st">"Tregsmem"</span>)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-9.png" width="700"></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto">ggcyto</a></span>(gs[ids], <span class="kw">aes</span>(<span class="dt">x =</span> CD8a, <span class="dt">y =</span> CD45RA), <span class="dt">subset =</span> <span class="st">"CD8+T"</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb26-2" title="2"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/ggcyto_par_set">ggcyto_par_set</a></span>(<span class="dt">limits =</span> <span class="st">"instrument"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">64</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb26-3" title="3"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcyto/topics/geom_gate">geom_gate</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CD8+Tnaive"</span>,<span class="st">"CD8+Tmem"</span>))</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/ggcyto-10.png" width="700"></p>
<p>Combine cell types of interest into one data frame. Change marker name from isotope name to protein name and remove markers that are unmapped.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" title="1">nodes_exclude =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"root"</span>,<span class="st">"singlet"</span>,<span class="st">"leukocyte"</span>,<span class="st">"mononuclear"</span>,</a>
<a class="sourceLine" id="cb27-2" title="2">                  <span class="st">"CD3-CD19-"</span>,<span class="st">"CD7-"</span>,<span class="st">"CD4-CD8a-"</span>,</a>
<a class="sourceLine" id="cb27-3" title="3">                  <span class="st">"CD4+T"</span>,<span class="st">"CD8+T"</span>,<span class="st">"T"</span>)</a>
<a class="sourceLine" id="cb27-4" title="4">nodes_all =<span class="st"> </span><span class="kw">getNodes</span>(gs, <span class="dt">path =</span> <span class="st">"auto"</span>) </a>
<a class="sourceLine" id="cb27-5" title="5">nodes_select =<span class="st"> </span>nodes_all[<span class="op">!</span>nodes_all <span class="op">%in%</span><span class="st"> </span>nodes_exclude]</a>
<a class="sourceLine" id="cb27-6" title="6">df_samples =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(nodes_select, <span class="cf">function</span>(celltype) {</a>
<a class="sourceLine" id="cb27-7" title="7">  fset =<span class="st"> </span><span class="kw">getData</span>(gs, celltype)</a>
<a class="sourceLine" id="cb27-8" title="8">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(fset), <span class="cf">function</span>(sample_id) {</a>
<a class="sourceLine" id="cb27-9" title="9">    marker_ids =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(fset<span class="op">@</span>colnames <span class="op">%in%</span><span class="st"> </span>markers<span class="op">$</span>isotope)</a>
<a class="sourceLine" id="cb27-10" title="10">    exprs =<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/flowCore/topics/flowFrame-class">exprs</a></span>(fset[[sample_id]]))[,marker_ids]</a>
<a class="sourceLine" id="cb27-11" title="11">    file_name =<span class="st"> </span><span class="kw">pData</span>(fset[sample_id])<span class="op">$</span>file_name</a>
<a class="sourceLine" id="cb27-12" title="12">    exprs <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_column</span>(file_name, celltype)</a>
<a class="sourceLine" id="cb27-13" title="13">  }) <span class="op">%&gt;%</span><span class="st"> </span>bind_rows</a>
<a class="sourceLine" id="cb27-14" title="14">}) <span class="op">%&gt;%</span><span class="st"> </span>bind_rows</a>
<a class="sourceLine" id="cb27-15" title="15">df_samples <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">inner_join</span>(sample_table,<span class="dt">by =</span> <span class="st">"file_name"</span>)</a>
<a class="sourceLine" id="cb27-16" title="16">oldnames =<span class="st"> </span>markers<span class="op">$</span>isotope</a>
<a class="sourceLine" id="cb27-17" title="17">newnames =<span class="st"> </span>markers<span class="op">$</span>protein_name</a>
<a class="sourceLine" id="cb27-18" title="18">df_samples <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">rename_at</span>(<span class="kw">vars</span>(oldnames), <span class="op">~</span><span class="st"> </span>newnames)</a>
<a class="sourceLine" id="cb27-19" title="19"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/str">str</a></span>(df_samples)</a></code></pre></div>
<pre><code>## Classes 'tbl_df', 'tbl' and 'data.frame':    2503107 obs. of  39 variables:
##  $ Event_length: num  46 21 37 17 35 27 17 34 16 28 ...
##  $ CD235ab_CD61: num  0 0 0 0 0.0995 ...
##  $ CD45        : num  4.62 4.65 4.74 4.33 4.45 ...
##  $ CD66        : num  0.802 0.9 1.348 1.511 0.626 ...
##  $ CD7         : num  5.12 4.28 4.61 5.19 4.73 ...
##  $ CD19        : num  0 1.57 0 0 1.31 ...
##  $ CD45RA      : num  4.16 4.3 3.48 3.38 4.26 ...
##  $ CD11b       : num  1.83 2.73 2.56 2.01 1.26 ...
##  $ CD4         : num  0.113 0.282 0.179 0 0.113 ...
##  $ CD8a        : num  0.0434 2.8996 2.8245 0 0 ...
##  $ CD11c       : num  1.2711 2.1562 2.0458 1.0197 0.0837 ...
##  $ CD123       : num  0 0.386 0.509 0 0 ...
##  $ pCREB       : num  0.744 1.728 1.149 0.759 1.177 ...
##  $ pSTAT5      : num  1.304 1.585 0.482 1.67 0.419 ...
##  $ pP38        : num  1.045 0.806 0.255 1.126 0.979 ...
##  $ TCRgd       : num  0 0 0.19 0.214 0.122 ...
##  $ pSTAT1      : num  2.64 3.49 1.16 2.96 2.57 ...
##  $ pSTAT3      : num  1.82 2.58 1.12 2.22 1.52 ...
##  $ prpS6       : num  1.71 1.71 1.384 0.866 1.577 ...
##  $ CD33        : num  0.2433 0.2183 0.0612 0.0121 0.7417 ...
##  $ pMAPKAPK    : num  2.1 2.68 1.22 2.2 2.49 ...
##  $ Tbet2       : num  2.34 2.97 1.07 2.84 2.02 ...
##  $ FoxP3       : num  0.385 1.071 0.945 0.188 1.186 ...
##  $ IkB         : num  1.01 0.584 0.281 0.203 0.628 ...
##  $ CD16        : num  0 0.3499 0.7307 0.0228 0.3036 ...
##  $ pNFkB       : num  1.716 1.136 0.467 0.789 1.852 ...
##  $ pERK1_2     : num  0.337 0 0 0.187 0 ...
##  $ CD25        : num  0.10953 0.96467 0.53152 0.00137 0 ...
##  $ CD3         : num  0 0.122 0 0 0 ...
##  $ CD15        : num  0.306 0.857 0 0.331 0.282 ...
##  $ HLA_DR      : num  0.692 0.294 1.971 0.85 0.217 ...
##  $ CD14        : num  0.3581 0 0 0.0592 0.0987 ...
##  $ CD56        : num  4.96 4.23 4.54 4.25 4.09 ...
##  $ DNA1        : num  4.11 3.93 3.82 4.05 4.09 ...
##  $ DNA2        : num  4.74 4.84 4.44 4.76 4.82 ...
##  $ file_name   : chr  "FR-FCM-ZY3Q/Gates_PTLG001_2_IFNa_100.fcs" "FR-FCM-ZY3Q/Gates_PTLG001_2_IFNa_100.fcs" "FR-FCM-ZY3Q/Gates_PTLG001_2_IFNa_100.fcs" "FR-FCM-ZY3Q/Gates_PTLG001_2_IFNa_100.fcs" ...
##  $ celltype    : chr  "NK" "NK" "NK" "NK" ...
##  $ donor       : chr  "PTLG001" "PTLG001" "PTLG001" "PTLG001" ...
##  $ term        : Factor w/ 2 levels "1st trimester",..: 2 2 2 2 2 2 2 2 2 2 ...</code></pre>
<p>List cell counts per donor and trimester.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(df_samples<span class="op">$</span>donor,df_samples<span class="op">$</span>term)</a></code></pre></div>
<pre><code>##          
##           1st trimester 3rd trimester
##   PTLG001         82937         80265
##   PTLG002         66573         74721
##   PTLG003        108142         75041
##   PTLG004         48169         57682
##   PTLG005         81455         87003
##   PTLG007        115016        135821
##   PTLG008         83824         73391
##   PTLG009        103724         96440
##   PTLG010         58504         76391
##   PTLG012         72357         68484
##   PTLG018         66348         92544
##   PTLG019         78024         71328
##   PTLG020         44037         49138
##   PTLG022         89129         70198
##   PTLG024        117099         79094
##   PTLG029         54313         45915</code></pre>
<p>Plot abundance of each celltype per sample.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" title="1">df_abundance =<span class="st"> </span>df_samples <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(file_name, donor, term, celltype) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-3" title="3"><span class="st">  </span><span class="kw">tally</span>()</a>
<a class="sourceLine" id="cb31-4" title="4"><span class="kw">ggplot</span>(df_abundance, <span class="kw">aes</span>(term, n, <span class="dt">color =</span> term)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-5" title="5"><span class="st">  </span><span class="kw">geom_violin</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-6" title="6"><span class="st">  </span><span class="kw">geom_jitter</span>(<span class="dt">width =</span> <span class="fl">0.2</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb31-7" title="7"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>celltype, <span class="dt">nrow =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb31-8" title="8"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/cell_abundance-1.png" width="700"></p>
<p>Focus on functional proteins.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" title="1">protein_names =<span class="st"> </span>markers <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-2" title="2"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(type <span class="op">==</span><span class="st"> "function"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-3" title="3"><span class="st">  </span>.<span class="op">$</span>protein_name</a>
<a class="sourceLine" id="cb32-4" title="4">protein_names</a></code></pre></div>
<pre><code>##  [1] "pCREB"    "pSTAT5"   "pP38"     "pSTAT1"   "pSTAT3"   "prpS6"   
##  [7] "pMAPKAPK" "IkB"      "pNFkB"    "pERK1_2"</code></pre>
<p>Declare the columns in <code>df_samples</code> that are not protein markers. In our example, we have donor ID, time point when the sample was collected, <code>FCS</code> filename, and the cell type that we have defined through gating.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" title="1">sample_info_names =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/flowCore/topics/flowFrame-class">names</a></span>(sample_table),<span class="st">"celltype"</span>)</a>
<a class="sourceLine" id="cb34-2" title="2">sample_info_names</a></code></pre></div>
<pre><code>## [1] "donor"     "term"      "file_name" "celltype"</code></pre>
</div>
<div id="data-exploration" class="section level1">
<h1 class="hasAnchor">
<a href="#data-exploration" class="anchor"></a>Data Exploration</h1>
<div id="mds" class="section level2">
<h2 class="hasAnchor">
<a href="#mds" class="anchor"></a>MDS</h2>
<p>MDS on median marker expression of all cell types following <span class="citation">Nowicka et al. (2017)</span>.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" title="1">CytoGLMM<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/CytoGLMM/topics/plot_mds">plot_mds</a></span>(df_samples,</a>
<a class="sourceLine" id="cb36-2" title="2">                   <span class="dt">protein_names =</span> protein_names,</a>
<a class="sourceLine" id="cb36-3" title="3">                   <span class="dt">sample_info_names =</span> sample_info_names,</a>
<a class="sourceLine" id="cb36-4" title="4">                   <span class="dt">color =</span> <span class="st">"celltype"</span>)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/plot_mds_celltype-1.png" width="700"></p>
<p>Subset to NK cells to illustrate visualization for one cell type.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" title="1">df_samples_subset =<span class="st"> </span>df_samples <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(celltype <span class="op">==</span><span class="st"> "NK"</span>)</a></code></pre></div>
<p>MDS on median marker expression of NK cells.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" title="1">CytoGLMM<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/CytoGLMM/topics/plot_mds">plot_mds</a></span>(df_samples_subset,</a>
<a class="sourceLine" id="cb38-2" title="2">                   <span class="dt">protein_names =</span> protein_names,</a>
<a class="sourceLine" id="cb38-3" title="3">                   <span class="dt">sample_info_names =</span> sample_info_names,</a>
<a class="sourceLine" id="cb38-4" title="4">                   <span class="dt">color =</span> <span class="st">"term"</span>)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/plot_mds_nk-1.png" width="700"></p>
</div>
<div id="heatmap" class="section level2">
<h2 class="hasAnchor">
<a href="#heatmap" class="anchor"></a>Heatmap</h2>
<p>Heatmap of median marker expression of all cell types following <span class="citation">Nowicka et al. (2017)</span>.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" title="1">CytoGLMM<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/CytoGLMM/topics/plot_heatmap">plot_heatmap</a></span>(df_samples,</a>
<a class="sourceLine" id="cb39-2" title="2">                       <span class="dt">protein_names =</span> protein_names,</a>
<a class="sourceLine" id="cb39-3" title="3">                       <span class="dt">sample_info_names =</span> sample_info_names,</a>
<a class="sourceLine" id="cb39-4" title="4">                       <span class="dt">arrange_by_1 =</span> <span class="st">"term"</span>,</a>
<a class="sourceLine" id="cb39-5" title="5">                       <span class="dt">arrange_by_2 =</span> <span class="st">"celltype"</span>)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/plot_heatmap_celltype-1.png" width="700"></p>
<p>Heatmap of median marker expression of NK cells.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" title="1">CytoGLMM<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/CytoGLMM/topics/plot_heatmap">plot_heatmap</a></span>(df_samples_subset,</a>
<a class="sourceLine" id="cb40-2" title="2">                       <span class="dt">protein_names =</span> protein_names,</a>
<a class="sourceLine" id="cb40-3" title="3">                       <span class="dt">sample_info_names =</span> sample_info_names,</a>
<a class="sourceLine" id="cb40-4" title="4">                       <span class="dt">arrange_by_1 =</span> <span class="st">"term"</span>)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/plot_heatmap_nk-1.png" width="700"></p>
</div>
<div id="pca" class="section level2">
<h2 class="hasAnchor">
<a href="#pca" class="anchor"></a>PCA</h2>
<p>PCA plot of all cell types.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" title="1">CytoGLMM<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/CytoGLMM/topics/plot_prcomp">plot_prcomp</a></span>(df_samples,</a>
<a class="sourceLine" id="cb41-2" title="2">                      <span class="dt">protein_names =</span> protein_names,</a>
<a class="sourceLine" id="cb41-3" title="3">                      <span class="dt">color_var =</span> <span class="st">"celltype"</span>,</a>
<a class="sourceLine" id="cb41-4" title="4">                      <span class="dt">repel =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/plot_prcomp_celltype-1.png" width="700"></p>
<p>PCA plot of NK cells.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" title="1">CytoGLMM<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/CytoGLMM/topics/plot_prcomp">plot_prcomp</a></span>(df_samples_subset,</a>
<a class="sourceLine" id="cb42-2" title="2">                      <span class="dt">protein_names =</span> protein_names,</a>
<a class="sourceLine" id="cb42-3" title="3">                      <span class="dt">color_var =</span> <span class="st">"term"</span>,</a>
<a class="sourceLine" id="cb42-4" title="4">                      <span class="dt">repel =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/plot_prcomp_nk-1.png" width="700"></p>
</div>
<div id="density-plots" class="section level2">
<h2 class="hasAnchor">
<a href="#density-plots" class="anchor"></a>Density Plots</h2>
<p>Density plots of one marker for all donors.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" title="1"><span class="kw">ggplot</span>(df_samples_subset, <span class="kw">aes_string</span>(<span class="dt">x =</span> <span class="st">"pCREB"</span>, <span class="dt">color =</span> <span class="st">"term"</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb43-2" title="2"><span class="st">  </span><span class="kw">geom_density</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb43-3" title="3"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>donor)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/density_plot-1.png" width="700"></p>
</div>
<div id="two-dimensional-histograms" class="section level2">
<h2 class="hasAnchor">
<a href="#two-dimensional-histograms" class="anchor"></a>Two-Dimensional Histograms</h2>
<p>Two-dimensional histograms for plotting two markers for all donors.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" title="1">colorscale =<span class="st"> </span><span class="kw">scale_fill_gradientn</span>(</a>
<a class="sourceLine" id="cb44-2" title="2">  <span class="dt">colors =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rev">rev</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/RColorBrewer/topics/ColorBrewer">brewer.pal</a></span>(<span class="dv">9</span>, <span class="st">"YlGnBu"</span>)), </a>
<a class="sourceLine" id="cb44-3" title="3">  <span class="dt">values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="op">-</span><span class="dv">5</span>, <span class="dv">0</span>, <span class="dt">length.out =</span> <span class="dv">100</span>)))</a>
<a class="sourceLine" id="cb44-4" title="4">  )</a>
<a class="sourceLine" id="cb44-5" title="5"><span class="kw">ggplot</span>(df_samples_subset, <span class="kw">aes_string</span>(<span class="dt">x =</span> <span class="st">"pSTAT1"</span>, <span class="dt">y =</span> <span class="st">"pSTAT3"</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb44-6" title="6"><span class="st">  </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">64</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb44-7" title="7"><span class="st">  </span>colorscale <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb44-8" title="8"><span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb44-9" title="9"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>donor)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/hist2_donors-1.png" width="700"></p>
<p>Two-dimensional histograms for group comparisons.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb45-1" title="1"><span class="kw">ggplot</span>(df_samples_subset, <span class="kw">aes_string</span>(<span class="dt">x =</span> <span class="st">"pSTAT1"</span>, <span class="dt">y =</span> <span class="st">"pSTAT3"</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-2" title="2"><span class="st">  </span><span class="kw">geom_hex</span>(<span class="dt">bins =</span> <span class="dv">64</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb45-3" title="3"><span class="st">  </span>colorscale <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb45-4" title="4"><span class="st">  </span><span class="kw">coord_fixed</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb45-5" title="5"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>term)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/hist2_groups-1.png" width="700"></p>
<p>NK cell count. List the smallest and largest.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" title="1">df_samples_subset <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(term,donor) <span class="op">%&gt;%</span><span class="st"> </span>tally <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(n)</a></code></pre></div>
<pre><code>## # A tibble: 32 x 3
## # Groups:   term [2]
##    term          donor       n
##    &lt;fct&gt;         &lt;chr&gt;   &lt;int&gt;
##  1 3rd trimester PTLG024  2380
##  2 3rd trimester PTLG001  3125
##  3 3rd trimester PTLG020  3230
##  4 1st trimester PTLG020  3412
##  5 1st trimester PTLG001  3474
##  6 3rd trimester PTLG009  3764
##  7 1st trimester PTLG018  4083
##  8 1st trimester PTLG024  4100
##  9 1st trimester PTLG010  4273
## 10 3rd trimester PTLG019  4542
## # ... with 22 more rows</code></pre>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb48-1" title="1">df_samples_subset <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(term,donor) <span class="op">%&gt;%</span><span class="st"> </span>tally <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(n))</a></code></pre></div>
<pre><code>## # A tibble: 32 x 3
## # Groups:   term [2]
##    term          donor       n
##    &lt;fct&gt;         &lt;chr&gt;   &lt;int&gt;
##  1 1st trimester PTLG008 13395
##  2 1st trimester PTLG022  8222
##  3 1st trimester PTLG003  8087
##  4 3rd trimester PTLG008  7953
##  5 3rd trimester PTLG018  7620
##  6 1st trimester PTLG029  7211
##  7 1st trimester PTLG019  6671
##  8 1st trimester PTLG012  6624
##  9 3rd trimester PTLG004  6501
## 10 3rd trimester PTLG002  6120
## # ... with 22 more rows</code></pre>
</div>
<div id="marker-correlations" class="section level2">
<h2 class="hasAnchor">
<a href="#marker-correlations" class="anchor"></a>Marker Correlations</h2>
<p>Plot marker correlations.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb50-1" title="1">mcor =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cor</a></span>(df_samples_subset <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(protein_names))</a>
<a class="sourceLine" id="cb50-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/ggcorrplot/topics/ggcorrplot">ggcorrplot</a></span>(mcor, <span class="dt">hc.order =</span> <span class="ot">TRUE</span>, <span class="dt">type =</span> <span class="st">"lower"</span>, </a>
<a class="sourceLine" id="cb50-3" title="3">           <span class="dt">outline.col =</span> <span class="st">"lightgray"</span>,</a>
<a class="sourceLine" id="cb50-4" title="4">           <span class="dt">colors =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"#6D9EC1"</span>, <span class="st">"white"</span>, <span class="st">"#E46726"</span>))</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/marker_correlations-1.png" width="700"></p>
</div>
</div>
<div id="regression-analysis-on-summarized-data" class="section level1">
<h1 class="hasAnchor">
<a href="#regression-analysis-on-summarized-data" class="anchor"></a>Regression Analysis on Summarized Data</h1>
<p>Classical differential analysis approach comparing median marker expressions <span class="citation">(Nowicka et al. 2017)</span>.</p>
<div id="plot-median-marker-expression" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-median-marker-expression" class="anchor"></a>Plot Median Marker Expression</h2>
<p>Plot all celltypes.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb51-1" title="1">df_median =<span class="st"> </span>df_samples <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb51-2" title="2"><span class="st">      </span><span class="kw">group_by</span>(file_name, donor, term, celltype) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb51-3" title="3"><span class="st">      </span><span class="kw">summarise_at</span>(protein_names, median)</a>
<a class="sourceLine" id="cb51-4" title="4">df_median_long =<span class="st"> </span><span class="kw">gather</span>(df_median, protein_name, median_expr, </a>
<a class="sourceLine" id="cb51-5" title="5">                        <span class="op">-</span>file_name, <span class="op">-</span>donor, <span class="op">-</span>term, <span class="op">-</span>celltype)</a>
<a class="sourceLine" id="cb51-6" title="6"><span class="kw">ggplot</span>(df_median_long, <span class="kw">aes</span>(protein_name, median_expr, <span class="dt">color =</span> term)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb51-7" title="7"><span class="st">  </span><span class="kw">geom_violin</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb51-8" title="8"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>celltype) <span class="op">+</span></a>
<a class="sourceLine" id="cb51-9" title="9"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x  =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>, <span class="dt">vjust=</span><span class="dv">0</span>))</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/median_expression_plot-1.png" width="700"></p>
<p>Zoom in on NK cells.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb52-1" title="1">df_median_long <span class="op">%&lt;&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(celltype <span class="op">==</span><span class="st"> "NK"</span>)</a>
<a class="sourceLine" id="cb52-2" title="2"><span class="kw">ggplot</span>(df_median_long, <span class="kw">aes</span>(term, median_expr, <span class="dt">color =</span> term)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-3" title="3"><span class="st">  </span><span class="kw">geom_violin</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-4" title="4"><span class="st">  </span><span class="kw">geom_jitter</span>(<span class="dt">width =</span> <span class="fl">0.2</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb52-5" title="5"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span><span class="st"> </span>protein_name, <span class="dt">nrow =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-6" title="6"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb52-7" title="7"><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">"NK"</span>)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/median_expression_plot_nk-1.png" width="700"></p>
<p>Zoom in on marker pSTAT1.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb53-1" title="1"><span class="kw">ggplot</span>(df_median, <span class="kw">aes</span>(term, pSTAT1, <span class="dt">color =</span> term)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb53-2" title="2"><span class="st">  </span><span class="kw">geom_violin</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb53-3" title="3"><span class="st">  </span><span class="kw">geom_jitter</span>(<span class="dt">width =</span> <span class="fl">0.2</span>, <span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb53-4" title="4"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>celltype, <span class="dt">nrow =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb53-5" title="5"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text.x =</span> <span class="kw">element_blank</span>())</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/median_expression_plot_pstat1-1.png" width="700"></p>
</div>
<div id="linear-mixed-model" class="section level2">
<h2 class="hasAnchor">
<a href="#linear-mixed-model" class="anchor"></a>Linear Mixed Model</h2>
<p>Mixed model with median expression as response variable, experimental condition as explanatory variable, and donor as random effect. Fit separate models for each protein and celltype combination.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb54-1" title="1">calc_pvalue =<span class="st"> </span><span class="cf">function</span>(fit) {</a>
<a class="sourceLine" id="cb54-2" title="2">  summ =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(fit)</a>
<a class="sourceLine" id="cb54-3" title="3">  <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/coef">coefficients</a></span>(summ)[<span class="st">"term3rd trimester"</span>, <span class="st">"Pr(&gt;|t|)"</span>]</a>
<a class="sourceLine" id="cb54-4" title="4">}</a>
<a class="sourceLine" id="cb54-5" title="5">df_median_long =<span class="st"> </span><span class="kw">gather</span>(df_median, protein_name, median_expr, </a>
<a class="sourceLine" id="cb54-6" title="6">                        <span class="op">-</span>file_name, <span class="op">-</span>donor, <span class="op">-</span>term, <span class="op">-</span>celltype)</a>
<a class="sourceLine" id="cb54-7" title="7">df_fits =<span class="st"> </span>df_median_long <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb54-8" title="8"><span class="st">  </span><span class="kw">group_by</span>(protein_name, celltype) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-9" title="9"><span class="st">  </span><span class="kw">nest</span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb54-10" title="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">fit =</span> <span class="kw">map</span>(data, <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/lme4/topics/lmer">lmer</a></span>(median_expr <span class="op">~</span><span class="st"> </span>term <span class="op">+</span><span class="st"> </span>(<span class="dv">1</span><span class="op">|</span>donor), .))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-11" title="11"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pvalue_unadj =</span> <span class="kw">map_dbl</span>(fit, <span class="op">~</span><span class="st"> </span><span class="kw">calc_pvalue</span>(.))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-12" title="12"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pvalue_adj =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/p.adjust">p.adjust</a></span>(pvalue_unadj, <span class="dt">method =</span> <span class="st">"BH"</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-13" title="13"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(protein_name, celltype, pvalue_adj)</a>
<a class="sourceLine" id="cb54-14" title="14">df_fits <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb54-15" title="15"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(pvalue_adj <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb54-16" title="16"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span>(celltype) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb54-17" title="17"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="dt">n =</span> <span class="ot">Inf</span>)</a></code></pre></div>
<pre><code>## # A tibble: 21 x 3
##    protein_name celltype   pvalue_adj
##    &lt;chr&gt;        &lt;chr&gt;           &lt;dbl&gt;
##  1 pSTAT1       B            0.0449  
##  2 pSTAT1       CD4+Tmem     0.00719 
##  3 IkB          CD4+Tmem     0.0392  
##  4 pNFkB        CD4+Tmem     0.00719 
##  5 pERK1_2      CD4+Tmem     0.0464  
##  6 pCREB        CD4+Tnaive   0.0179  
##  7 pSTAT5       CD4+Tnaive   0.0254  
##  8 pSTAT1       CD4+Tnaive   0.0122  
##  9 IkB          CD4+Tnaive   0.00719 
## 10 pNFkB        CD4+Tnaive   0.00851 
## 11 pSTAT1       CD8+Tmem     0.00858 
## 12 pSTAT5       CD8+Tnaive   0.0254  
## 13 pSTAT1       CD8+Tnaive   0.00719 
## 14 IkB          CD8+Tnaive   0.00719 
## 15 pNFkB        CD8+Tnaive   0.00719 
## 16 pSTAT1       cMC          0.0179  
## 17 pSTAT1       gdT          0.00851 
## 18 pSTAT1       NK           0.000364
## 19 pNFkB        NK           0.0179  
## 20 pERK1_2      NK           0.0453  
## 21 pSTAT1       Tregsmem     0.0179</code></pre>
</div>
</div>
<div id="regression-analysis-on-all-the-data" class="section level1">
<h1 class="hasAnchor">
<a href="#regression-analysis-on-all-the-data" class="anchor"></a>Regression Analysis on All The Data</h1>
<p>For the regression analysis, we will focus only on NK cells. We can repeat the same analysis for each cell type of interest.</p>
<div id="generalized-linear-mixed-model" class="section level2">
<h2 class="hasAnchor">
<a href="#generalized-linear-mixed-model" class="anchor"></a>Generalized Linear Mixed Model</h2>
<p>Fit a Generalized Linear Mixed Model (GLMM) with donor random effects. This function is a wrapper around the package <code>mbest</code> <span class="citation">(Perry 2017)</span>.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb56-1" title="1">df_samples_subset<span class="op">$</span>term <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">factor</a></span>(<span class="dt">levels =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"1st trimester"</span>,</a>
<a class="sourceLine" id="cb56-2" title="2">                                              <span class="st">"3rd trimester"</span>))</a>
<a class="sourceLine" id="cb56-3" title="3">glmm_fit =<span class="st"> </span>CytoGLMM<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/CytoGLMM/topics/cytoglmm">cytoglmm</a></span>(df_samples_subset, </a>
<a class="sourceLine" id="cb56-4" title="4">                              <span class="dt">protein_names =</span> protein_names,</a>
<a class="sourceLine" id="cb56-5" title="5">                              <span class="dt">condition =</span> <span class="st">"term"</span>, <span class="dt">group =</span> <span class="st">"donor"</span>)</a>
<a class="sourceLine" id="cb56-6" title="6">glmm_fit</a></code></pre></div>
<pre><code>## number of cells per group and condition:         
##           1st trimester 3rd trimester
##   PTLG001          3474          3125
##   PTLG002          5438          6120
##   PTLG003          8087          5035
##   PTLG004          4991          6501
##   PTLG005          6105          5074
##   PTLG007          5766          5302
##   PTLG008         13395          7953
##   PTLG009          5177          3764
##   PTLG010          4273          4908
##   PTLG012          6624          5643
##   PTLG018          4083          7620
##   PTLG019          6671          4542
##   PTLG020          3412          3230
##   PTLG022          8222          5709
##   PTLG024          4100          2380
##   PTLG029          7211          4937
## 
## proteins included in the analysis:
##  pCREB pSTAT5 pP38 pSTAT1 pSTAT3 prpS6 pMAPKAPK IkB pNFkB pERK1_2 
## 
## condition compared: term 
## grouping variable: donor</code></pre>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb58-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(glmm_fit)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/glmm_fit-1.png" width="700"></p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb59-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(glmm_fit) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(pvalues_adj <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   protein_name pvalues_unadj pvalues_adj
##   &lt;chr&gt;                &lt;dbl&gt;       &lt;dbl&gt;
## 1 pSTAT3            6.18e-21    6.18e-20
## 2 pSTAT1            6.58e-19    3.29e-18
## 3 pSTAT5            7.47e- 9    2.49e- 8</code></pre>
<p>Add pSTAT1, pSTAT3, and pSTAT5 into one marker.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb61-1" title="1">df_samples_subset <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">pSTAT_sum =</span> pSTAT1<span class="op">+</span>pSTAT3<span class="op">+</span>pSTAT5)</a>
<a class="sourceLine" id="cb61-2" title="2">protein_names_sum =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(</a>
<a class="sourceLine" id="cb61-3" title="3">  <span class="st">"pSTAT_sum"</span>, </a>
<a class="sourceLine" id="cb61-4" title="4">  protein_names[<span class="op">!</span>protein_names <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"pSTAT1"</span>,<span class="st">"pSTAT3"</span>,<span class="st">"pSTAT5"</span>)]</a>
<a class="sourceLine" id="cb61-5" title="5">)</a>
<a class="sourceLine" id="cb61-6" title="6">glmm_fit =<span class="st"> </span>CytoGLMM<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/CytoGLMM/topics/cytoglmm">cytoglmm</a></span>(df_samples_subset, </a>
<a class="sourceLine" id="cb61-7" title="7">                              <span class="dt">protein_names =</span> protein_names_sum,</a>
<a class="sourceLine" id="cb61-8" title="8">                              <span class="dt">condition =</span> <span class="st">"term"</span>, <span class="dt">group =</span> <span class="st">"donor"</span>)</a>
<a class="sourceLine" id="cb61-9" title="9"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(glmm_fit)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/glmm_fit_combine-1.png" width="700"></p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb62-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(glmm_fit) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(pvalues_adj <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>)</a></code></pre></div>
<pre><code>## # A tibble: 1 x 3
##   protein_name pvalues_unadj pvalues_adj
##   &lt;chr&gt;                &lt;dbl&gt;       &lt;dbl&gt;
## 1 pSTAT_sum      0.000000189  0.00000151</code></pre>
<p>Take differences between pSTAT1, pSTAT3, and pSTAT5.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb64-1" title="1">df_samples_subset <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">pSTAT3_minus_pSTAT1 =</span> pSTAT3<span class="op">-</span>pSTAT1)</a>
<a class="sourceLine" id="cb64-2" title="2">df_samples_subset <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">pSTAT5_minus_pSTAT1 =</span> pSTAT5<span class="op">-</span>pSTAT1)</a>
<a class="sourceLine" id="cb64-3" title="3">protein_names_diff =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(</a>
<a class="sourceLine" id="cb64-4" title="4">  <span class="st">"pSTAT3_minus_pSTAT1"</span>,<span class="st">"pSTAT5_minus_pSTAT1"</span>,</a>
<a class="sourceLine" id="cb64-5" title="5">  protein_names[<span class="op">!</span>protein_names <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"pSTAT3"</span>,<span class="st">"pSTAT5"</span>)]</a>
<a class="sourceLine" id="cb64-6" title="6">)</a>
<a class="sourceLine" id="cb64-7" title="7">glmm_fit =<span class="st"> </span>CytoGLMM<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/CytoGLMM/topics/cytoglmm">cytoglmm</a></span>(df_samples_subset, </a>
<a class="sourceLine" id="cb64-8" title="8">                              <span class="dt">protein_names =</span> protein_names_diff,</a>
<a class="sourceLine" id="cb64-9" title="9">                              <span class="dt">condition =</span> <span class="st">"term"</span>, <span class="dt">group =</span> <span class="st">"donor"</span>)</a>
<a class="sourceLine" id="cb64-10" title="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(glmm_fit)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/glmm_fit_differences-1.png" width="700"></p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb65-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(glmm_fit) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(pvalues_adj <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   protein_name        pvalues_unadj pvalues_adj
##   &lt;chr&gt;                       &lt;dbl&gt;       &lt;dbl&gt;
## 1 pSTAT3_minus_pSTAT1      6.18e-21    6.18e-20
## 2 pSTAT5_minus_pSTAT1      7.47e- 9    3.74e- 8
## 3 pSTAT1                   2.19e- 4    7.31e- 4</code></pre>
<p>Add interactions between pSTAT1, pSTAT3, and pSTAT5.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" title="1">df_samples_subset <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">pSTAT_I15 =</span> pSTAT1<span class="op">*</span>pSTAT5)</a>
<a class="sourceLine" id="cb67-2" title="2">df_samples_subset <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">pSTAT_I35 =</span> pSTAT3<span class="op">*</span>pSTAT5)</a>
<a class="sourceLine" id="cb67-3" title="3">df_samples_subset <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">pSTAT_I13 =</span> pSTAT1<span class="op">*</span>pSTAT3)</a>
<a class="sourceLine" id="cb67-4" title="4">df_samples_subset <span class="op">%&lt;&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">pSTAT_I135 =</span> pSTAT1<span class="op">*</span>pSTAT3<span class="op">*</span>pSTAT5)</a>
<a class="sourceLine" id="cb67-5" title="5">protein_names_interactions =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(protein_names,<span class="st">"pSTAT_I15"</span>,<span class="st">"pSTAT_I35"</span>,</a>
<a class="sourceLine" id="cb67-6" title="6">                               <span class="st">"pSTAT_I13"</span>,<span class="st">"pSTAT_I135"</span>)</a>
<a class="sourceLine" id="cb67-7" title="7">glmm_fit =<span class="st"> </span>CytoGLMM<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/CytoGLMM/topics/cytoglmm">cytoglmm</a></span>(df_samples_subset, </a>
<a class="sourceLine" id="cb67-8" title="8">                              <span class="dt">protein_names =</span> protein_names_interactions,</a>
<a class="sourceLine" id="cb67-9" title="9">                              <span class="dt">condition =</span> <span class="st">"term"</span>, <span class="dt">group =</span> <span class="st">"donor"</span>)</a>
<a class="sourceLine" id="cb67-10" title="10"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(glmm_fit)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/glmm_fit_interaction-1.png" width="700"></p>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(glmm_fit) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(pvalues_adj <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 3
##   protein_name pvalues_unadj pvalues_adj
##   &lt;chr&gt;                &lt;dbl&gt;       &lt;dbl&gt;
## 1 pSTAT3            2.52e-13    3.53e-12
## 2 pSTAT1            3.47e-11    2.43e-10
## 3 pSTAT_I13         1.82e- 4    8.48e- 4
## 4 pERK1_2           1.55e- 2    4.82e- 2
## 5 pNFkB             1.90e- 2    4.82e- 2
## 6 pSTAT5            2.06e- 2    4.82e- 2</code></pre>
</div>
<div id="generalized-linear-model-with-bootstrap" class="section level2">
<h2 class="hasAnchor">
<a href="#generalized-linear-model-with-bootstrap" class="anchor"></a>Generalized Linear Model with Bootstrap</h2>
<p>Instead of modeling the donor effect, we can use bootstrap resampling. In our experience, this type of regression gives also good results when samples are not matched between conditions on the same donor.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" title="1">glm_fit =<span class="st"> </span>CytoGLMM<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/CytoGLMM/topics/cytoglm">cytoglm</a></span>(df_samples_subset, </a>
<a class="sourceLine" id="cb70-2" title="2">                            <span class="dt">num_boot =</span> <span class="dv">1000</span>,</a>
<a class="sourceLine" id="cb70-3" title="3">                            <span class="dt">protein_names =</span> protein_names,</a>
<a class="sourceLine" id="cb70-4" title="4">                            <span class="dt">condition =</span> <span class="st">"term"</span>, <span class="dt">group =</span> <span class="st">"donor"</span>)</a>
<a class="sourceLine" id="cb70-5" title="5">glm_fit</a></code></pre></div>
<pre><code>## 
## #######################
## ## paired analysis ####
## #######################
## 
## number of bootstrap samples: 1000 
## 
## number of cells per group and condition:         
##           1st trimester 3rd trimester
##   PTLG001          3474          3125
##   PTLG002          5438          6120
##   PTLG003          8087          5035
##   PTLG004          4991          6501
##   PTLG005          6105          5074
##   PTLG007          5766          5302
##   PTLG008         13395          7953
##   PTLG009          5177          3764
##   PTLG010          4273          4908
##   PTLG012          6624          5643
##   PTLG018          4083          7620
##   PTLG019          6671          4542
##   PTLG020          3412          3230
##   PTLG022          8222          5709
##   PTLG024          4100          2380
##   PTLG029          7211          4937
## 
## proteins included in the analysis:
##  pCREB pSTAT5 pP38 pSTAT1 pSTAT3 prpS6 pMAPKAPK IkB pNFkB pERK1_2 
## 
## condition compared: term 
## grouping variable: donor</code></pre>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(glm_fit)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/glm_fit-1.png" width="700"></p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(glm_fit) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(pvalues_adj <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>)</a></code></pre></div>
<pre><code>## # A tibble: 3 x 3
##   protein_name pvalues_unadj pvalues_adj
##   &lt;chr&gt;                &lt;dbl&gt;       &lt;dbl&gt;
## 1 pSTAT1               0.002     0.00667
## 2 pSTAT3               0.002     0.00667
## 3 pSTAT5               0.002     0.00667</code></pre>
</div>
<div id="mixture-of-regressions" class="section level2">
<h2 class="hasAnchor">
<a href="#mixture-of-regressions" class="anchor"></a>Mixture of Regressions</h2>
<p>Fit a mixture of regression model to identity clusters of donors or outliers. This function is a wrapper around the package <code>flexmix</code> <span class="citation">(Grün and Leisch 2007)</span>.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" title="1">num_donors =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nlevels">nlevels</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/factor">as.factor</a></span>(df_samples_subset<span class="op">$</span>donor))</a>
<a class="sourceLine" id="cb75-2" title="2">mix_fit =<span class="st"> </span>CytoGLMM<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/CytoGLMM/topics/cytoflexmix">cytoflexmix</a></span>(df_samples_subset, </a>
<a class="sourceLine" id="cb75-3" title="3">                                <span class="dt">protein_names =</span> protein_names,</a>
<a class="sourceLine" id="cb75-4" title="4">                                <span class="dt">condition =</span> <span class="st">"term"</span>, <span class="dt">group =</span> <span class="st">"donor"</span>, </a>
<a class="sourceLine" id="cb75-5" title="5">                                <span class="dt">ks =</span> <span class="dv">1</span><span class="op">:</span>num_donors)</a>
<a class="sourceLine" id="cb75-6" title="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(mix_fit)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/mix_fit-1.png" width="700"></p>
<p>The plotting function automatically uses the BIC criterion to select the number of clusters. In this case, it picks 10 clusters.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb76-1" title="1"><span class="kw"><a href="../reference/plot_model_selection.html">plot_model_selection</a></span>(mix_fit)</a></code></pre></div>
<p><img src="CytoGLMM_files/figure-html/bic_model_selection-1.png" width="700"></p>
</div>
</div>
<div id="summarizedexperiment" class="section level1">
<h1 class="hasAnchor">
<a href="#summarizedexperiment" class="anchor"></a>SummarizedExperiment</h1>
<p>We create a <code>SummarizedExperiment</code> object containing marker, sample table, and untransformed protein counts. This way we can store all the information of this experiment in one file and load it again in subsequent analyses.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" title="1">markers <span class="op">%&lt;&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(type <span class="op">!=</span><span class="st"> "none"</span>)</a>
<a class="sourceLine" id="cb77-2" title="2">d_combined =<span class="st"> </span>df_samples <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-3" title="3"><span class="st">  </span><span class="kw">select</span>(markers<span class="op">$</span>protein_name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-4" title="4"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">mutate_all</a></span>(<span class="dt">.funs =</span> inv_func) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-5" title="5"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">mutate_all</a></span>(<span class="dt">.funs =</span> round) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb77-6" title="6"><span class="st">  </span>as.matrix</a>
<a class="sourceLine" id="cb77-7" title="7">row_data =<span class="st"> </span>df_samples <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-8" title="8"><span class="st">  </span><span class="kw">select</span>(sample_info_names) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb77-9" title="9"><span class="st">  </span>as.data.frame</a>
<a class="sourceLine" id="cb77-10" title="10">col_data =<span class="st"> </span>markers <span class="op">%&gt;%</span><span class="st"> </span>as.data.frame</a>
<a class="sourceLine" id="cb77-11" title="11">se_aghaeepour2017immune =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/SummarizedExperiment/topics/RangedSummarizedExperiment-class">SummarizedExperiment</a></span>(</a>
<a class="sourceLine" id="cb77-12" title="12">  <span class="dt">assays =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">exprs =</span> d_combined),</a>
<a class="sourceLine" id="cb77-13" title="13">  <span class="dt">colData =</span> col_data,</a>
<a class="sourceLine" id="cb77-14" title="14">  <span class="dt">rowData =</span> row_data</a>
<a class="sourceLine" id="cb77-15" title="15">)</a>
<a class="sourceLine" id="cb77-16" title="16"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/save">save</a></span>(se_aghaeepour2017immune, <span class="dt">file =</span> <span class="st">"se_aghaeepour2017immune.Rdata"</span>)</a></code></pre></div>
</div>
<div id="session-info" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#session-info" class="anchor"></a>Session Info</h1>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/sessionInfo">sessionInfo</a></span>()</a></code></pre></div>
<pre><code>## R version 3.5.1 (2018-07-02)
## Platform: x86_64-apple-darwin15.6.0 (64-bit)
## Running under: macOS  10.14.3
## 
## Matrix products: default
## BLAS: /Library/Frameworks/R.framework/Versions/3.5/Resources/lib/libRblas.0.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/3.5/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## attached base packages:
##  [1] grid      stats4    parallel  stats     graphics  grDevices utils    
##  [8] datasets  methods   base     
## 
## other attached packages:
##  [1] bindrcpp_0.2.2              hexbin_1.27.2              
##  [3] Rgraphviz_2.24.0            graph_1.58.2               
##  [5] lmerTest_3.1-0              lme4_1.1-18-1              
##  [7] Matrix_1.2-14               SummarizedExperiment_1.10.1
##  [9] DelayedArray_0.6.6          BiocParallel_1.14.2        
## [11] matrixStats_0.54.0          Biobase_2.40.0             
## [13] GenomicRanges_1.32.7        GenomeInfoDb_1.16.0        
## [15] IRanges_2.14.12             S4Vectors_0.18.3           
## [17] BiocGenerics_0.26.0         ggcorrplot_0.1.2           
## [19] RColorBrewer_1.1-2          scales_1.0.0               
## [21] ggcyto_1.11.4               openCyto_1.18.0            
## [23] flowWorkspace_3.28.2        ncdfFlow_2.26.0            
## [25] BH_1.66.0-1                 RcppArmadillo_0.9.200.7.0  
## [27] flowCore_1.46.2             FlowRepositoryR_1.12.0     
## [29] magrittr_1.5                forcats_0.3.0              
## [31] stringr_1.3.1               dplyr_0.7.7                
## [33] purrr_0.2.5                 readr_1.1.1                
## [35] tidyr_0.8.2                 tibble_1.4.2               
## [37] ggplot2_3.1.0               tidyverse_1.2.1            
## [39] CytoGLMM_0.1.0              Rcpp_0.12.19               
## [41] BiocStyle_2.8.2            
## 
## loaded via a namespace (and not attached):
##   [1] utf8_1.1.4             R.utils_2.8.0          ks_1.11.4             
##   [4] tidyselect_0.2.5       munsell_0.5.0          codetools_0.2-15      
##   [7] withr_2.1.2            colorspace_1.3-2       flowViz_1.44.0        
##  [10] knitr_1.20             rstudioapi_0.8         geometry_0.3-6        
##  [13] flowClust_3.18.0       robustbase_0.93-3      dimRed_0.1.0          
##  [16] labeling_0.3           GenomeInfoDbData_1.1.0 mnormt_1.5-5          
##  [19] MCMCpack_1.4-4         pheatmap_1.0.10        rprojroot_1.3-2       
##  [22] coda_0.19-2            ipred_0.9-8            xfun_0.4              
##  [25] R6_2.3.0               doParallel_1.0.14      clue_0.3-57           
##  [28] flexmix_2.3-14         DRR_0.0.3              bitops_1.0-6          
##  [31] assertthat_0.2.0       nnet_7.3-12            gtable_0.2.0          
##  [34] ddalpha_1.3.4          mcmc_0.9-5             sandwich_2.5-0        
##  [37] timeDate_3043.102      rlang_0.3.0.1          MatrixModels_0.4-1    
##  [40] CVST_0.2-2             mbest_0.6              RcppRoll_0.3.0        
##  [43] splines_3.5.1          lazyeval_0.2.1         ModelMetrics_1.2.2    
##  [46] broom_0.5.0            yaml_2.2.0             reshape2_1.4.3        
##  [49] abind_1.4-5            modelr_0.1.2           backports_1.1.2       
##  [52] IDPmisc_1.1.19         RBGL_1.56.0            caret_6.0-80          
##  [55] tools_3.5.1            lava_1.6.3             bookdown_0.7          
##  [58] logging_0.7-103        plyr_1.8.4             zlibbioc_1.26.0       
##  [61] RCurl_1.95-4.11        ggpubr_0.1.8           rpart_4.1-13          
##  [64] cowplot_0.9.3          zoo_1.8-4              sfsmisc_1.1-2         
##  [67] haven_1.1.2            ggrepel_0.8.0          cluster_2.0.7-1       
##  [70] fs_1.2.6               factoextra_1.0.5       fda_2.4.8             
##  [73] data.table_1.11.8      SparseM_1.77           mvtnorm_1.0-8         
##  [76] hms_0.4.2              evaluate_0.12          XML_3.98-1.17         
##  [79] mclust_5.4.1           readxl_1.1.0           gridExtra_2.3         
##  [82] compiler_3.5.1         flowStats_3.38.0       KernSmooth_2.23-15    
##  [85] crayon_1.3.4           minqa_1.2.4            R.oo_1.22.0           
##  [88] htmltools_0.3.6        corpcor_1.6.9          pcaPP_1.9-73          
##  [91] rrcov_1.4-7            speedglm_0.3-2         lubridate_1.7.4       
##  [94] magic_1.5-9            MASS_7.3-51            cli_1.0.1             
##  [97] R.methodsS3_1.7.1      bindr_0.1.1            gower_0.1.2           
## [100] pkgconfig_2.0.2        bigmemory.sri_0.1.3    pkgdown_1.3.0         
## [103] numDeriv_2016.8-1      recipes_0.1.3          xml2_1.2.0            
## [106] roxygen2_6.1.1         foreach_1.4.4          XVector_0.20.0        
## [109] prodlim_2018.04.18     rvest_0.3.2            digest_0.6.18         
## [112] pls_2.7-0              strucchange_1.5-1      rmarkdown_1.10        
## [115] cellranger_1.1.0       kernlab_0.9-27         gtools_3.8.1          
## [118] commonmark_1.7         quantreg_5.36          modeltools_0.2-22     
## [121] nloptr_1.2.1           nlme_3.1-137           jsonlite_1.5          
## [124] fansi_0.4.0            bigmemory_4.5.33       desc_1.2.0            
## [127] pillar_1.3.0           lattice_0.20-35        httr_1.3.1            
## [130] DEoptimR_1.0-8         survival_2.43-1        glue_1.3.0            
## [133] iterators_1.0.10       class_7.3-14           stringi_1.2.4         
## [136] latticeExtra_0.6-28    memoise_1.1.0</code></pre>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-aghaeepour2017immune">
<p>Aghaeepour, Nima, Edward A. Ganio, David Mcilwain, Amy S. Tsai, Martha Tingle, Van GassenSofie, Dyani K. Gaudilliere, et al. 2017. “An Immune Clock of Human Pregnancy.” <em>Science Immunology</em> 2 (15): eaan2946. <a href="https://doi.org/10.1126/sciimmunol.aan2946">https://doi.org/10.1126/sciimmunol.aan2946</a>.</p>
</div>
<div id="ref-grun2007fitting">
<p>Grün, Bettina, and Friedrich Leisch. 2007. “Fitting Finite Mixtures of Generalized Linear Regressions in R.” <em>Computational Statistics &amp; Data Analysis</em> 51 (11): 5247–52.</p>
</div>
<div id="ref-Nowicka2017cytof">
<p>Nowicka, M, C Krieg, LM Weber, FJ Hartmann, S Guglietta, B Becher, MP Levesque, and MD Robinson. 2017. “CyTOF Workflow: Differential Discovery in High-Throughput High-Dimensional Cytometry Datasets.” <em>F1000Research</em> 6 (748). <a href="https://doi.org/10.12688/f1000research.11622.2">https://doi.org/10.12688/f1000research.11622.2</a>.</p>
</div>
<div id="ref-perry2017fast">
<p>Perry, Patrick O. 2017. “Fast Moment-Based Estimation for Hierarchical Models.” <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em> 79 (1): 267–91.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#goal">Goal</a></li>
      <li><a href="#prerequisites">Prerequisites</a></li>
      <li>
<a href="#download-and-prepare-data">Download and Prepare Data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#fcs-files">FCS Files</a></li>
      <li><a href="#sample-table">Sample Table</a></li>
      <li><a href="#marker-table">Marker Table</a></li>
      </ul>
</li>
      <li><a href="#gating">Gating</a></li>
      <li>
<a href="#data-exploration">Data Exploration</a><ul class="nav nav-pills nav-stacked">
<li><a href="#mds">MDS</a></li>
      <li><a href="#heatmap">Heatmap</a></li>
      <li><a href="#pca">PCA</a></li>
      <li><a href="#density-plots">Density Plots</a></li>
      <li><a href="#two-dimensional-histograms">Two-Dimensional Histograms</a></li>
      <li><a href="#marker-correlations">Marker Correlations</a></li>
      </ul>
</li>
      <li>
<a href="#regression-analysis-on-summarized-data">Regression Analysis on Summarized Data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#plot-median-marker-expression">Plot Median Marker Expression</a></li>
      <li><a href="#linear-mixed-model">Linear Mixed Model</a></li>
      </ul>
</li>
      <li>
<a href="#regression-analysis-on-all-the-data">Regression Analysis on All The Data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#generalized-linear-mixed-model">Generalized Linear Mixed Model</a></li>
      <li><a href="#generalized-linear-model-with-bootstrap">Generalized Linear Model with Bootstrap</a></li>
      <li><a href="#mixture-of-regressions">Mixture of Regressions</a></li>
      </ul>
</li>
      <li><a href="#summarizedexperiment">SummarizedExperiment</a></li>
      <li><a href="#session-info">Session Info</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Christof Seiler.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
